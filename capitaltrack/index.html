<button onclick="capitaltrackLoginGoogle()">üîë Iniciar sesi√≥n (Google)</button>
<button onclick="capitaltrackCloudSaveNow()">‚òÅÔ∏è Guardar en la nube</button>
<!DOCTYPE html>
<html lang="es">
<!--
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë             PORTFOLIO MANAGER PRO - VERSION 17 HEATMAP        ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    
    üìä CARACTER√çSTICAS:
    ‚úÖ Base de datos con 294 CEDEARs y ratios de conversi√≥n
    ‚úÖ Sistema CCL hist√≥rico (guarda CCL en cada transacci√≥n)
    ‚úÖ Precios en tiempo real desde Yahoo Finance USA
    ‚úÖ Exportar/Importar portfolio completo
    ‚úÖ 6 pesta√±as: Resumen, Historial, Gr√°ficos, Rendimientos, Mapa de Calor, Ventas
    ‚úÖ Historial con tabla estilo Ameba (v13)
    ‚úÖ Pesta√±a Ventas funcional (v14)
    ‚úÖ Rendimientos Hist√≥ricos (v15)
    ‚úÖ Sistema H√≠brido Inteligente (v16)
    
    üÜï MAPA DE CALOR PERSONALIZADO (NUEVO en v17):
    ‚úÖ Visualizaci√≥n de variaci√≥n diaria
       - Solo muestra TUS activos en cartera
       - Colores seg√∫n rendimiento (verde/rojo)
       - Tama√±o seg√∫n magnitud del cambio
    ‚úÖ Actualizaci√≥n en tiempo real
       - Click en "Actualizar" para refrescar
       - Obtiene variaci√≥n diaria de Yahoo Finance
    ‚úÖ Dise√±o estilo Ameba Heatmap
       - Grid responsive
       - Hover effects
       - Tooltips informativos
    
    üî• SISTEMA H√çBRIDO INTELIGENTE (v16):
    ‚úÖ Sistema de 3 capas para obtener datos:
       1. Cache Local (localStorage) - Instant√°neo
       2. Yahoo Finance (ilimitado) - Fuente primaria
       3. Alpha Vantage (500/d√≠a) - Solo si Yahoo no tiene
    ‚úÖ Precios hist√≥ricos REALES por mes
    ‚úÖ Contador de llamadas API
    ‚úÖ Optimizaci√≥n inteligente
    ‚úÖ Indicadores de fuente de datos
    
    üìÖ √öltima actualizaci√≥n: 13 de Diciembre 2024
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager Pro v26 OBJETIVOS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1f36 0%, #0f1419 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #00d4ff;
            font-size: 28px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: 1px solid #dc2626;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }

        .summary-section {
            margin-bottom: 30px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            padding: 25px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .summary-card.ars {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .summary-card.usd {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.2) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .summary-card.ccl {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .summary-card h3 {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .search-bar {
            margin-bottom: 20px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        .portfolio-table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(255, 255, 255, 0.05);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #a0a0a0;
        }

        td {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .ticker-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ticker-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1f36;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #00d4ff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #a0a0a0;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .last-update {
            text-align: right;
            color: #6b7280;
            font-size: 12px;
            margin-top: 10px;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 8px;
            color: #a0a0a0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .transactions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .transaction-item.sell {
            border-left-color: #ef4444;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .transaction-ticker {
            font-weight: 700;
            font-size: 16px;
            color: #00d4ff;
        }

        .transaction-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .transaction-type.buy {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .transaction-type.sell {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .transaction-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 13px;
            color: #a0a0a0;
        }

        .transaction-detail span {
            color: #e0e0e0;
            font-weight: 600;
        }

        /* ========================================== */
        /* HISTORIAL TABLE - AMEBA STYLE (NEW v13)   */
        /* ========================================== */
        
        .historial-table-container {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .historial-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .historial-table thead {
            background: rgba(255, 255, 255, 0.05);
        }

        .historial-table th {
            padding: 15px 12px;
            text-align: left;
            color: #9ca3af;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .historial-table th:first-child {
            padding-left: 20px;
        }

        .historial-table th:last-child {
            text-align: center;
        }

        .historial-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .historial-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .historial-table td {
            padding: 16px 12px;
            color: #e0e0e0;
            vertical-align: middle;
        }

        .historial-table td:first-child {
            padding-left: 20px;
        }

        .ticker-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ticker-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            color: white;
            flex-shrink: 0;
        }

        .ticker-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ticker-name {
            font-weight: 600;
            color: #e0e0e0;
            font-size: 14px;
        }

        .ticker-ratio {
            font-size: 11px;
            color: #6b7280;
        }

        .tipo-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .tipo-badge.compra {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .tipo-badge.venta {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .historial-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .historial-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-edit {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .btn-edit:hover {
            background: rgba(59, 130, 246, 0.25);
            transform: translateY(-1px);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.25);
            transform: translateY(-1px);
        }

        .precio-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .precio-ars {
            color: #e0e0e0;
            font-weight: 500;
        }

        .precio-usd {
            color: #6b7280;
            font-size: 12px;
        }

        /* ========================================== */
        /* VENTAS TAB - AMEBA STYLE (NEW v14)         */
        /* ========================================== */
        
        .ventas-ticker-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .ventas-ticker-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ventas-ticker-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: white;
        }

        .ventas-ticker-name {
            font-size: 24px;
            font-weight: 700;
            color: #e0e0e0;
        }

        .ventas-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .ventas-summary-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .ventas-summary-card h4 {
            color: #9ca3af;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .ventas-summary-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #e0e0e0;
        }

        .ventas-summary-card .value.positive {
            color: #10b981;
        }

        .ventas-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            overflow: hidden;
        }

        .ventas-table thead {
            background: rgba(255, 255, 255, 0.05);
        }

        .ventas-table th {
            padding: 12px 10px;
            text-align: left;
            color: #9ca3af;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ventas-table th:last-child,
        .ventas-table td:last-child {
            text-align: right;
        }

        .ventas-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .ventas-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .ventas-table td {
            padding: 14px 10px;
            color: #e0e0e0;
        }

        .ganancia-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ganancia-valor {
            color: #10b981;
            font-weight: 600;
        }

        .ganancia-porcentaje {
            color: #6b7280;
            font-size: 11px;
        }

        .no-ventas {
            padding: 60px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 2px dashed rgba(255, 255, 255, 0.1);
        }

        .no-ventas-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .no-ventas-title {
            color: #9ca3af;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .no-ventas-text {
            color: #6b7280;
            font-size: 14px;
        }

        /* ========================================== */
        /* RENDIMIENTOS TAB - FILTERS & CHARTS (v15) */
        /* ========================================== */
        
        .rendimientos-filters {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: #9ca3af;
            font-size: 13px;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 12px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.08);
        }

        .rendimientos-chart-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .rendimientos-chart-title {
            color: #3b82f6;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .rendimientos-table-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 25px;
        }

        .rendimientos-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .rendimientos-table thead {
            background: rgba(255, 255, 255, 0.05);
        }

        .rendimientos-table th {
            padding: 15px 12px;
            text-align: left;
            color: #9ca3af;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rendimientos-table th:first-child {
            padding-left: 20px;
        }

        .rendimientos-table th:not(:first-child) {
            text-align: right;
        }

        .rendimientos-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .rendimientos-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .rendimientos-table td {
            padding: 16px 12px;
            color: #e0e0e0;
        }

        .rendimientos-table td:first-child {
            padding-left: 20px;
            font-weight: 600;
        }

        .rendimientos-table td:not(:first-child) {
            text-align: right;
        }

        .rendimientos-table .positive {
            color: #10b981;
        }

        .rendimientos-table .negative {
            color: #ef4444;
        }

        .rendimientos-table .neutral {
            color: #6b7280;
        }

        /* ===============================================
           HEATMAP STYLES - v17
           =============================================== */
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            width: 100%;
        }

        .heatmap-cell {
            position: relative;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100px;
            border: 2px solid transparent;
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

        .heatmap-cell-ticker {
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .heatmap-cell-change {
            font-size: 20px;
            font-weight: 800;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .heatmap-cell-value {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
        }

        /* Color intensities based on change % */
        .heatmap-positive-strong {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .heatmap-positive-moderate {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .heatmap-neutral {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .heatmap-negative-moderate {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .heatmap-negative-strong {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
        }

        /* Tama√±os basados en magnitud del cambio */
        .heatmap-size-xs {
            min-height: 80px;
            grid-column: span 1;
            grid-row: span 1;
        }

        .heatmap-size-sm {
            min-height: 100px;
            grid-column: span 1;
            grid-row: span 1;
        }

        .heatmap-size-md {
            min-height: 120px;
            grid-column: span 2;
            grid-row: span 1;
        }

        .heatmap-size-lg {
            min-height: 150px;
            grid-column: span 2;
            grid-row: span 2;
        }

        .heatmap-size-xl {
            min-height: 180px;
            grid-column: span 3;
            grid-row: span 2;
        }

        @media (max-width: 768px) {
            .heatmap-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .heatmap-size-md,
            .heatmap-size-lg,
            .heatmap-size-xl {
                grid-column: span 1;
                grid-row: span 1;
            }
        }
        
        /* Period selector buttons for Benchmarks */
        .period-btn {
            padding: 10px 20px;
            border: 1px solid #2d2d2d;
            background: #1a1a1a;
            color: #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .period-btn:hover {
            background: #2d2d2d;
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .period-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Portfolio Manager Pro <span style="font-size: 14px; color: #6b7280; font-weight: 400;">v26 OBJETIVOS üè¶</span></h1>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="importFromExcel()" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">üìä Importar Excel</button>
                <button class="btn btn-secondary" onclick="exportData()">üì• Exportar JSON</button>
                <button class="btn btn-secondary" onclick="importData()">üì§ Importar JSON</button>
                <button class="btn btn-primary" onclick="openTransactionModal()">+ Nueva Transacci√≥n</button>
            </div>
        </div>

        <!-- Hidden file input for Excel -->
        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelFile(event)">

        <!-- API Counter - Sistema H√≠brido -->
        <div style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid rgba(255,255,255,0.1);">
            <div style="display: flex; gap: 20px; align-items: center;">
                <span style="color: #e0e0e0; font-size: 13px; font-weight: 600;">üîÑ Sistema H√≠brido Activo</span>
                <span style="color: #10b981; font-size: 12px;" id="apiCallsCounter">0/500 llamadas (500 disponibles)</span>
            </div>
            <div style="display: flex; gap: 15px; font-size: 11px;">
                <span style="color: #10b981;">‚óè</span> <span style="color: #a0a0a0;">Cache / Yahoo</span>
                <span style="color: #f59e0b;">‚óè</span> <span style="color: #a0a0a0;">Alpha Vantage</span>
                <span style="color: #ef4444;">‚óè</span> <span style="color: #a0a0a0;">Estimado</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('resumen')">üìä Resumen</button>
            <button class="tab" onclick="switchTab('historial')">üìã Historial</button>
            <button class="tab" onclick="switchTab('graficos')">üìà Gr√°ficos</button>
            <button class="tab" onclick="switchTab('rendimientos')">üìâ Rendimientos</button>
            <button class="tab" onclick="switchTab('heatmap')">üî• Mapa de Calor</button>
            <button class="tab" onclick="switchTab('ventas')">üí∞ Ventas</button>
            <button class="tab" onclick="switchTab('benchmarks')">üìä Benchmarks</button>
            <button class="tab" onclick="switchTab('objetivos')">üéØ Objetivos</button>
        </div>

        <div id="resumenTab" class="tab-content">
            <div class="summary-section">
                <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 18px;">üìä Vista Detallada</h3>
                <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Lista detallada de todas tus operaciones</p>
                
                <div class="summary-cards">
                    <!-- Total Invertido -->
                    <div class="summary-card ars">
                        <h3>üí∞ Total invertido</h3>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: #a0a0a0; font-size: 13px;">ARS</span>
                                <span style="color: #e0e0e0; font-size: 20px; font-weight: 600;" id="totalInvestedARS">$0,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #a0a0a0; font-size: 13px;">USD</span>
                                <span style="color: #e0e0e0; font-size: 20px; font-weight: 600;" id="totalInvestedUSD">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Valor Actual -->
                    <div class="summary-card usd">
                        <h3>üìà Valor actual</h3>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: #a0a0a0; font-size: 13px;">ARS</span>
                                <span style="color: #e0e0e0; font-size: 20px; font-weight: 600;" id="totalValueARS">$0,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #a0a0a0; font-size: 13px;">USD</span>
                                <span style="color: #e0e0e0; font-size: 20px; font-weight: 600;" id="totalValueUSD">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Rendimiento No Realizado -->
                    <div class="summary-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(124, 58, 237, 0.2) 100%); border: 1px solid rgba(139, 92, 246, 0.3);">
                        <h3>üíé Rendimiento no realizado</h3>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: #a0a0a0; font-size: 13px;">ARS</span>
                                <span style="font-size: 20px; font-weight: 600;" id="returnAbsoluteARS">$0,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: #a0a0a0; font-size: 13px;"></span>
                                <span style="font-size: 16px; font-weight: 600;" id="returnPercentARS">+0.00%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: #a0a0a0; font-size: 13px;">USD</span>
                                <span style="font-size: 20px; font-weight: 600;" id="returnAbsoluteUSD">$0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #a0a0a0; font-size: 13px;"></span>
                                <span style="font-size: 16px; font-weight: 600;" id="returnPercentUSD">+0.00%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de Posiciones -->
                    <div class="summary-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%); border: 1px solid rgba(16, 185, 129, 0.3);">
                        <h3>üìã Resumen de posiciones</h3>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #a0a0a0; font-size: 13px;">Total instrumentos:</span>
                                <span style="color: #10b981; font-size: 32px; font-weight: 700;" id="totalInstruments">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- CCL -->
                    <div class="summary-card ccl">
                        <h3>üíµ CCL (USD/ARS)</h3>
                        <div style="margin-top: 15px;">
                            <div style="text-align: center;">
                                <span style="color: #fbbf24; font-size: 32px; font-weight: 700;" id="cclRate">$0,00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="üîç Buscar por ticker, tag o descripci√≥n..." onkeyup="filterTable()">
            </div>

            <div class="portfolio-table">
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Cant.</th>
                            <th>Precio Promedio</th>
                            <th>Precio Actual</th>
                            <th>Precio Actual USD</th>
                            <th>Valor Posici√≥n (USD)</th>
                            <th>Rendimiento ARS</th>
                            <th>Rendimiento USD</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioBody">
                        <!-- Portfolio rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <div class="last-update" id="lastUpdate">
                √öltima actualizaci√≥n: hace 0 minutos
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                <div style="font-size: 13px; color: #3b82f6; margin-bottom: 5px;">üí° <strong>Sistema Inteligente:</strong> CCL hist√≥rico + Ratios personalizados</div>
                <div style="font-size: 12px; color: #6b7280;">
                    ‚Ä¢ Guarda el CCL al momento de cada transacci√≥n<br>
                    ‚Ä¢ Si un ticker no est√° en la base, puedes agregar su ratio manualmente<br>
                    ‚Ä¢ Los ratios personalizados se guardan para futuros usos<br>
                    ‚Ä¢ Presiona F12 para ver logs detallados
                </div>
            </div>
        </div>

        <div id="historialTab" class="tab-content" style="display: none;">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 18px;">üìã Historial de Transacciones</h3>
            <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Registro completo de todas tus operaciones</p>
            
            <div class="transactions-list" id="transactionsList">
                <!-- Transactions will be inserted here -->
            </div>
        </div>

        <div id="graficosTab" class="tab-content" style="display: none;">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 18px;">üìà Gr√°ficos</h3>
            <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Visualizaci√≥n de rendimiento y evoluci√≥n del portfolio</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Resumen de Portfolio -->
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h4 style="color: #3b82f6; margin-bottom: 5px; font-size: 16px;">üìä Resumen de Portfolio</h4>
                    <p style="color: #6b7280; margin-bottom: 20px; font-size: 13px;">Distribuci√≥n general de tus inversiones</p>
                    <canvas id="portfolioChart" style="max-height: 400px;"></canvas>
                </div>

                <!-- Distribuci√≥n por Mercado -->
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h4 style="color: #3b82f6; margin-bottom: 5px; font-size: 16px;">üåç Distribuci√≥n por Mercado</h4>
                    <p style="color: #6b7280; margin-bottom: 20px; font-size: 13px;">Exposici√≥n por mercados financieros</p>
                    <canvas id="marketChart" style="max-height: 400px;"></canvas>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
                <!-- Distribuci√≥n por Sector -->
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h4 style="color: #3b82f6; margin-bottom: 5px; font-size: 16px;">üìà Distribuci√≥n por Sector</h4>
                    <p style="color: #6b7280; margin-bottom: 20px; font-size: 13px;">Diversificaci√≥n sectorial de tu portfolio</p>
                    <canvas id="sectorChart" style="max-height: 400px;"></canvas>
                </div>

                <!-- Valor por Acci√≥n -->
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h4 style="color: #3b82f6; margin-bottom: 5px; font-size: 16px;">üìä Valor por Acci√≥n</h4>
                    <p style="color: #6b7280; margin-bottom: 20px; font-size: 13px;">Comparaci√≥n del valor monetario de cada acci√≥n en tu portfolio</p>
                    <div style="margin-bottom: 10px; text-align: right;">
                        <button id="valueChartARS" onclick="switchValueChart('ARS')" style="padding: 5px 15px; background: #10b981; border: none; border-radius: 5px; color: white; cursor: pointer; margin-left: 5px; font-size: 12px;">ARS</button>
                        <button id="valueChartUSD" onclick="switchValueChart('USD')" style="padding: 5px 15px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 5px; color: white; cursor: pointer; margin-left: 5px; font-size: 12px;">USD</button>
                    </div>
                    <canvas id="valueChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>

        <div id="rendimientosTab" class="tab-content" style="display: none;">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 18px;">üìâ Rendimientos Hist√≥ricos</h3>
            <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Evoluci√≥n del portfolio y rendimiento mensual</p>
            
            <!-- Filtros -->
            <div class="rendimientos-filters">
                <div class="filter-group">
                    <label>Portfolio</label>
                    <select id="rendPortfolio">
                        <option value="todos">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Per√≠odo Desde</label>
                    <input type="month" id="rendPeriodoDesde" value="2023-07">
                </div>
                <div class="filter-group">
                    <label>Per√≠odo Hasta</label>
                    <input type="month" id="rendPeriodoHasta" value="2025-12">
                </div>
                <div class="filter-group">
                    <label>Moneda</label>
                    <select id="rendMoneda">
                        <option value="ARS">ARS</option>
                        <option value="USD">USD</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Filtros</label>
                    <select id="rendFiltros">
                        <option value="activos">Activos</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Datos Hist√≥ricos üÜï</label>
                    <select id="rendDatosReales">
                        <option value="false">Estimados (precio actual)</option>
                        <option value="true">Reales (usa API)</option>
                    </select>
                </div>
            </div>
            
            <!-- Alert de datos reales -->
            <div id="rendimientosAlert" style="display: none; background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <div style="color: #3b82f6; font-size: 13px; font-weight: 600; margin-bottom: 5px;">üîÑ Cargando datos hist√≥ricos reales...</div>
                <div style="color: #6b7280; font-size: 12px;" id="rendimientosAlertText">Esto puede tardar unos segundos...</div>
            </div>

            <!-- Gr√°fico 1: Evoluci√≥n del Portfolio -->
            <div class="rendimientos-chart-container">
                <div class="rendimientos-chart-title">Evoluci√≥n del Portfolio y Operaciones</div>
                <canvas id="rendEvolucionChart" style="max-height: 400px;"></canvas>
            </div>

            <!-- Gr√°fico 2: Rendimiento Mensual -->
            <div class="rendimientos-chart-container">
                <div class="rendimientos-chart-title">Rendimiento Mensual</div>
                <canvas id="rendMensualChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- Tabla Mensual -->
            <div class="rendimientos-table-container">
                <table class="rendimientos-table">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Neto (ARS)</th>
                            <th>Valor Portfolio (ARS)</th>
                            <th>P&L No Realizado (ARS)</th>
                            <th>Rendimiento Mes</th>
                            <th>Rendimiento Acumulado</th>
                        </tr>
                    </thead>
                    <tbody id="rendimientosTableBody">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- HEATMAP TAB -->
        <div id="heatmapTab" class="tab-content" style="display: none;">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 18px;">üî• Mapa de Calor</h3>
            <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Visualiza la variaci√≥n diaria de tus activos en cartera</p>
            
            <!-- Controles -->
            <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                <button class="btn btn-secondary" onclick="refreshHeatmap()" style="display: flex; align-items: center; gap: 8px;">
                    <span>üîÑ</span>
                    <span>Actualizar</span>
                </button>
                <div style="flex: 1; text-align: right; color: #6b7280; font-size: 13px;">
                    <span id="heatmapLastUpdate">√öltima actualizaci√≥n: --:--</span>
                </div>
            </div>

            <!-- Leyenda de colores -->
            <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #10b981; border-radius: 4px;"></div>
                        <span style="color: #e0e0e0; font-size: 13px;">Positivo (+3% o m√°s)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #059669; border-radius: 4px;"></div>
                        <span style="color: #e0e0e0; font-size: 13px;">Moderado (+1% a +3%)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #6b7280; border-radius: 4px;"></div>
                        <span style="color: #e0e0e0; font-size: 13px;">Neutro (-1% a +1%)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #dc2626; border-radius: 4px;"></div>
                        <span style="color: #e0e0e0; font-size: 13px;">Moderado (-3% a -1%)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: #991b1b; border-radius: 4px;"></div>
                        <span style="color: #e0e0e0; font-size: 13px;">Negativo (-3% o menos)</span>
                    </div>
                </div>
            </div>

            <!-- Heatmap Container -->
            <div id="heatmapContainer" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px; min-height: 500px;">
                <div style="text-align: center; padding: 50px; color: #6b7280;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üî•</div>
                    <div style="font-size: 16px;">Click en "Actualizar" para generar el mapa de calor</div>
                </div>
            </div>
        </div>

        <div id="ventasTab" class="tab-content" style="display: none;">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 18px;">üí∞ Ventas Realizadas</h3>
            <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Resumen de tus ventas y ganancias obtenidas</p>
            
            <div id="ventasContent">
                <!-- Sales will be inserted here dynamically -->
            </div>
        </div>
        <div id="benchmarksTab" class="tab-content" style="display: none;">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 18px;">üìä Benchmarks</h3>
            <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Compara tu portfolio vs √≠ndices principales</p>

                    <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 18px;">üìä Comparaci√≥n vs Benchmarks</h3>
                    <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Compara el rendimiento de tu portfolio con los principales √≠ndices del mercado</p>
                    
                    
                    <!-- Period Selector -->
                    <div style="margin-bottom: 25px;">
                        <label style="color: #e0e0e0; font-size: 14px; margin-bottom: 10px; display: block;">üìÖ Per√≠odo de comparaci√≥n:</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="period-btn active" onclick="changeBenchmarkPeriod('1M')" data-period="1M">1 Mes</button>
                            <button class="period-btn" onclick="changeBenchmarkPeriod('3M')" data-period="3M">3 Meses</button>
                            <button class="period-btn" onclick="changeBenchmarkPeriod('6M')" data-period="6M">6 Meses</button>
                            <button class="period-btn" onclick="changeBenchmarkPeriod('1Y')" data-period="1Y">1 A√±o</button>
                            <button class="period-btn" onclick="changeBenchmarkPeriod('YTD')" data-period="YTD">YTD</button>
                            <button class="period-btn" onclick="changeBenchmarkPeriod('ALL')" data-period="ALL">Todo</button>
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div style="background: #1a1a1a; border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 1px solid #2d2d2d;">
                        <h4 style="color: #e0e0e0; margin-bottom: 20px; font-size: 16px;">üìà Rendimiento Comparativo</h4>
                        <div style="position: relative; height: 400px;">
                            <canvas id="benchmarkChart"></canvas>
                        </div>
                        <div style="margin-top: 20px; display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                            <label style="display: flex; align-items: center; gap: 8px; color: #e0e0e0; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="showPortfolio" checked onchange="updateBenchmarkChart()">
                                <span style="width: 20px; height: 3px; background: #3b82f6; display: inline-block; border-radius: 2px;"></span>
                                Tu Portfolio
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; color: #e0e0e0; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="showSPY" checked onchange="updateBenchmarkChart()">
                                <span style="width: 20px; height: 3px; background: #10b981; display: inline-block; border-radius: 2px;"></span>
                                SPY (S&P 500)
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; color: #e0e0e0; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="showQQQ" checked onchange="updateBenchmarkChart()">
                                <span style="width: 20px; height: 3px; background: #f59e0b; display: inline-block; border-radius: 2px;"></span>
                                QQQ (Nasdaq)
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; color: #e0e0e0; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="showMERVAL" checked onchange="updateBenchmarkChart()">
                                <span style="width: 20px; height: 3px; background: #ef4444; display: inline-block; border-radius: 2px;"></span>
                                MERVAL
                            </label>
                        </div>
                    </div>

                    <!-- Comparison Table -->
                    <div style="background: #1a1a1a; border-radius: 12px; padding: 25px; border: 1px solid #2d2d2d;">
                        <h4 style="color: #e0e0e0; margin-bottom: 20px; font-size: 16px;">üìä Tabla Comparativa</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #2d2d2d;">
                                        <th style="text-align: left; padding: 15px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">M√©trica</th>
                                        <th style="text-align: right; padding: 15px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">Tu Portfolio</th>
                                        <th style="text-align: right; padding: 15px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">SPY</th>
                                        <th style="text-align: right; padding: 15px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">QQQ</th>
                                        <th style="text-align: right; padding: 15px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">MERVAL</th>
                                    </tr>
                                </thead>
                                <tbody id="benchmarkTableBody">
                                    <tr style="border-bottom: 1px solid #2d2d2d;">
                                        <td style="padding: 15px 10px; color: #e0e0e0; font-size: 14px;">Retorno Per√≠odo</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #e0e0e0; font-size: 14px; font-weight: 600;" id="returnPortfolio">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #e0e0e0; font-size: 14px;" id="returnSPY">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #e0e0e0; font-size: 14px;" id="returnQQQ">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #e0e0e0; font-size: 14px;" id="returnMERVAL">-</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #2d2d2d;">
                                        <td style="padding: 15px 10px; color: #e0e0e0; font-size: 14px;">Mejor D√≠a</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #10b981; font-size: 14px;" id="bestDayPortfolio">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #10b981; font-size: 14px;" id="bestDaySPY">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #10b981; font-size: 14px;" id="bestDayQQQ">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #10b981; font-size: 14px;" id="bestDayMERVAL">-</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #2d2d2d;">
                                        <td style="padding: 15px 10px; color: #e0e0e0; font-size: 14px;">Peor D√≠a</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #ef4444; font-size: 14px;" id="worstDayPortfolio">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #ef4444; font-size: 14px;" id="worstDaySPY">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #ef4444; font-size: 14px;" id="worstDayQQQ">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #ef4444; font-size: 14px;" id="worstDayMERVAL">-</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #2d2d2d;">
                                        <td style="padding: 15px 10px; color: #e0e0e0; font-size: 14px;">D√≠as Positivos</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #e0e0e0; font-size: 14px;" id="positiveDaysPortfolio">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #e0e0e0; font-size: 14px;" id="positiveDaysSPY">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #e0e0e0; font-size: 14px;" id="positiveDaysQQQ">-</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #e0e0e0; font-size: 14px;" id="positiveDaysMERVAL">-</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 15px 10px; color: #e0e0e0; font-size: 14px;">Diferencia vs T√∫</td>
                                        <td style="padding: 15px 10px; text-align: right; color: #6b7280; font-size: 14px;">-</td>
                                        <td style="padding: 15px 10px; text-align: right; font-size: 14px; font-weight: 600;" id="diffSPY">-</td>
                                        <td style="padding: 15px 10px; text-align: right; font-size: 14px; font-weight: 600;" id="diffQQQ">-</td>
                                        <td style="padding: 15px 10px; text-align: right; font-size: 14px; font-weight: 600;" id="diffMERVAL">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="benchmarkLoading" style="display: none; text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                        <p style="font-size: 16px;">Cargando datos de benchmarks...</p>
                    </div>
        </div>

        <!-- Objetivos Financieros Tab -->
        <div id="objetivosTab" class="tab-content" style="display: none;">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 18px;">üéØ Objetivos Financieros</h3>
            <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Planifica y monitorea tus metas de inversi√≥n</p>

            <!-- Panel de Objetivos -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- Objetivo Corto Plazo -->
                <div style="background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%); border-radius: 12px; padding: 25px; border: 1px solid #2d2d2d;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="font-size: 32px; margin-right: 15px;">üìÖ</div>
                        <div>
                            <h4 style="color: #e0e0e0; margin: 0; font-size: 16px;">CORTO PLAZO</h4>
                            <p style="color: #6b7280; margin: 0; font-size: 13px;">Semanal</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <p style="color: #a0a0a0; margin-bottom: 8px; font-size: 13px;">Meta: <input type="number" id="metaCorta" value="200" style="width: 80px; background: #2d2d2d; border: 1px solid #3d3d3d; color: #e0e0e0; padding: 4px 8px; border-radius: 6px; font-size: 13px;"> USD/semana</p>
                        <p style="color: #e0e0e0; font-size: 14px; margin: 5px 0;">Semana actual:</p>
                        <p style="font-size: 24px; font-weight: 700; margin: 5px 0;" id="crecimientoMesActual">-</p>
                        <p style="font-size: 13px; margin: 5px 0;" id="cumpleMesActual">-</p>
                        <p style="color: #e0e0e0; font-size: 14px; margin-top: 15px;">Semana anterior:</p>
                        <p style="font-size: 18px; font-weight: 600; margin: 5px 0;" id="crecimientoMesAnterior">-</p>
                        <p style="font-size: 13px; margin: 5px 0;" id="cumpleMesAnterior">-</p>
                    </div>
                </div>

                <!-- Objetivo Largo Plazo -->
                <div style="background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%); border-radius: 12px; padding: 25px; border: 1px solid #2d2d2d;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="font-size: 32px; margin-right: 15px;">üèÜ</div>
                        <div>
                            <h4 style="color: #e0e0e0; margin: 0; font-size: 16px;">LARGO PLAZO</h4>
                            <p style="color: #6b7280; margin: 0; font-size: 13px;">Jubilaci√≥n 2033</p>
                        </div>
                    </div>
                    <div>
                        <p style="color: #a0a0a0; margin-bottom: 8px; font-size: 13px;">Meta: <input type="number" id="metaLarga" value="70000" style="width: 100px; background: #2d2d2d; border: 1px solid #3d3d3d; color: #e0e0e0; padding: 4px 8px; border-radius: 6px; font-size: 13px;"> USD</p>
                        <p style="color: #a0a0a0; margin-bottom: 8px; font-size: 13px;">Fecha: <input type="month" id="fechaJubilacion" value="2033-02" style="background: #2d2d2d; border: 1px solid #3d3d3d; color: #e0e0e0; padding: 4px 8px; border-radius: 6px; font-size: 13px;"></p>
                        <p style="color: #e0e0e0; font-size: 14px; margin: 8px 0;">Meses restantes: <span id="mesesRestantes">-</span></p>
                        <p style="color: #e0e0e0; font-size: 14px; margin: 8px 0;">Valor actual: <span style="font-size: 18px; font-weight: 600;" id="valorActualObjetivo">-</span></p>
                        <p style="color: #e0e0e0; font-size: 14px; margin: 8px 0;">Falta: <span style="font-size: 16px; font-weight: 600; color: #f59e0b;" id="faltaObjetivo">-</span></p>
                        <div style="margin-top: 10px; background: #2d2d2d; border-radius: 8px; height: 20px; overflow: hidden;">
                            <div id="barraProgresoObjetivo" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #10b981); transition: width 0.3s;"></div>
                        </div>
                        <p style="color: #a0a0a0; font-size: 12px; text-align: center; margin-top: 5px;">Progreso: <span id="porcentajeProgresoObjetivo">-</span></p>
                    </div>
                </div>
            </div>

            <button onclick="guardarObjetivos()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; margin-bottom: 30px;">üíæ Guardar metas</button>

            <!-- Rendimiento Semanal -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 1px solid #2d2d2d;">
                <h4 style="color: #e0e0e0; margin-bottom: 20px; font-size: 16px;">üìä Evoluci√≥n Semanal</h4>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #2d2d2d;">
                                <th style="text-align: left; padding: 12px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">Semana</th>
                                <th style="text-align: right; padding: 12px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">Valor Inicial</th>
                                <th style="text-align: right; padding: 12px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">Aportes</th>
                                <th style="text-align: right; padding: 12px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">Ganancia</th>
                                <th style="text-align: right; padding: 12px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">Valor Final</th>
                                <th style="text-align: right; padding: 12px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;">Œî Semanal</th>
                                <th style="text-align: center; padding: 12px 10px; color: #a0a0a0; font-weight: 600; font-size: 13px;"></th>
                            </tr>
                        </thead>
                        <tbody id="tablaRendimientoMensual">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                    <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
                                    <p>Calculando rendimiento semanal...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="color: #6b7280; font-size: 12px; margin-top: 15px;">
                    <strong>Leyenda:</strong> Aportes = Suma de compras de la semana | Ganancia = Cambio en valor de mercado | Œî Semanal = Aportes + Ganancia | ‚úÖ = Cumple objetivo | ‚ùå = No cumple
                </p>
            </div>

            <!-- Estad√≠sticas -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- √öltimas 6 semanas -->
                <div style="background: #1a1a1a; border-radius: 12px; padding: 25px; border: 1px solid #2d2d2d;">
                    <h4 style="color: #e0e0e0; margin-bottom: 20px; font-size: 16px;">üìà √öLTIMAS 6 SEMANAS</h4>
                    <div style="space-y: 10px;">
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Promedio aportes: <span style="color: #e0e0e0; font-weight: 600;" id="promedioAportes6m">-</span></p>
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Promedio ganancia: <span id="promedioGanancia6m">-</span></p>
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Crecimiento promedio: <span id="crecimientoPromedio6m">-</span></p>
                        <hr style="border: none; border-top: 1px solid #2d2d2d; margin: 15px 0;">
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Semanas cumpliendo meta: <span style="color: #e0e0e0; font-weight: 600;" id="mesesCumplen6m">-</span></p>
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Racha actual: <span id="rachaActual">-</span></p>
                        <hr style="border: none; border-top: 1px solid #2d2d2d; margin: 15px 0;">
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Mejor semana: <span id="mejorMes6m">-</span></p>
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Peor semana: <span id="peorMes6m">-</span></p>
                    </div>
                </div>

                <!-- Desde inicio -->
                <div style="background: #1a1a1a; border-radius: 12px; padding: 25px; border: 1px solid #2d2d2d;">
                    <h4 style="color: #e0e0e0; margin-bottom: 20px; font-size: 16px;">üìä DESDE INICIO</h4>
                    <div style="space-y: 10px;">
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Total invertido: <span style="color: #e0e0e0; font-weight: 600;" id="totalInvertido">-</span></p>
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Valor actual: <span style="color: #e0e0e0; font-weight: 600;" id="valorActualStats">-</span></p>
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Ganancia/P√©rdida: <span id="gananciaTotalStats">-</span></p>
                        <hr style="border: none; border-top: 1px solid #2d2d2d; margin: 15px 0;">
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Rendimiento anual: <span id="rendimientoAnual">-</span></p>
                        <p style="color: #a0a0a0; font-size: 13px; margin: 8px 0;">Semanas operando: <span style="color: #e0e0e0; font-weight: 600;" id="mesesOperando">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Proyecci√≥n -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 25px; border: 1px solid #2d2d2d; margin-bottom: 30px;">
                <h4 style="color: #e0e0e0; margin-bottom: 20px; font-size: 16px;">üîÆ PROYECCI√ìN AL 2033</h4>
                <p style="color: #a0a0a0; font-size: 13px; margin-bottom: 20px;">Basado en tu rendimiento actual:</p>
                
                <div style="background: #252525; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                    <h5 style="color: #e0e0e0; margin: 0 0 15px 0; font-size: 14px;">ESCENARIO 1: Mantienes ritmo actual</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <p style="color: #a0a0a0; font-size: 12px; margin: 0;">Promedio aportes:</p>
                            <p style="color: #e0e0e0; font-size: 14px; font-weight: 600; margin: 5px 0;" id="proyeccionAportes">-</p>
                        </div>
                        <div>
                            <p style="color: #a0a0a0; font-size: 12px; margin: 0;">Promedio ganancia:</p>
                            <p style="color: #e0e0e0; font-size: 14px; font-weight: 600; margin: 5px 0;" id="proyeccionGanancia">-</p>
                        </div>
                        <div>
                            <p style="color: #a0a0a0; font-size: 12px; margin: 0;">Valor proyectado:</p>
                            <p style="color: #10b981; font-size: 18px; font-weight: 700; margin: 5px 0;" id="valorProyectado">-</p>
                        </div>
                    </div>
                    <p id="resultadoProyeccion1" style="margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 6px; font-size: 13px;">-</p>
                </div>

                <div style="background: #252525; border-radius: 10px; padding: 20px; border-left: 4px solid #f59e0b;">
                    <h5 style="color: #e0e0e0; margin: 0 0 15px 0; font-size: 14px;">ESCENARIO 2: Solo cumples meta semanal</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <p style="color: #a0a0a0; font-size: 12px; margin: 0;">Crecimiento:</p>
                            <p style="color: #e0e0e0; font-size: 14px; font-weight: 600; margin: 5px 0;" id="proyeccionMeta">-</p>
                        </div>
                        <div>
                            <p style="color: #a0a0a0; font-size: 12px; margin: 0;">Valor proyectado:</p>
                            <p style="color: #f59e0b; font-size: 18px; font-weight: 700; margin: 5px 0;" id="valorProyectadoMeta">-</p>
                        </div>
                    </div>
                    <p id="resultadoProyeccion2" style="margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 6px; font-size: 13px;">-</p>
                </div>

                <p style="color: #6b7280; font-size: 12px; margin-top: 20px; text-align: center;">
                    ‚ö†Ô∏è Estas son proyecciones basadas en promedios. El mercado es vol√°til, los resultados pueden variar.
                </p>
            </div>

            <!-- An√°lisis -->
            <div style="background: #1a1a1a; border-radius: 12px; padding: 25px; border: 1px solid #2d2d2d;">
                <h4 style="color: #e0e0e0; margin-bottom: 20px; font-size: 16px;">üí° AN√ÅLISIS DE SITUACI√ìN</h4>
                <div id="analisisEstado" style="padding: 15px; background: #252525; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 20px;">
                    <p style="color: #e0e0e0; font-weight: 600; font-size: 15px; margin: 0 0 10px 0;">Estado general: <span id="estadoGeneral">-</span></p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <!-- Lo que va bien -->
                    <div style="background: #252525; padding: 20px; border-radius: 10px;">
                        <h5 style="color: #10b981; margin: 0 0 15px 0; font-size: 14px; font-weight: 600;">‚úÖ LO QUE VA BIEN:</h5>
                        <div id="loQuevaBien" style="color: #a0a0a0; font-size: 13px;">
                            <p>Calculando...</p>
                        </div>
                    </div>

                    <!-- √Åreas de atenci√≥n -->
                    <div style="background: #252525; padding: 20px; border-radius: 10px;">
                        <h5 style="color: #f59e0b; margin: 0 0 15px 0; font-size: 14px; font-weight: 600;">‚ö†Ô∏è √ÅREAS DE ATENCI√ìN:</h5>
                        <div id="areasAtencion" style="color: #a0a0a0; font-size: 13px;">
                            <p>Calculando...</p>
                        </div>
                    </div>
                </div>

                <div style="background: #252525; padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <h5 style="color: #3b82f6; margin: 0 0 15px 0; font-size: 14px; font-weight: 600;">üìå RECOMENDACIONES:</h5>
                    <div id="recomendaciones" style="color: #a0a0a0; font-size: 13px;">
                        <p>Calculando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nueva Transacci√≥n</h2>
            </div>
            <form id="transactionForm">
                <div class="form-group">
                    <label>Tipo de Operaci√≥n</label>
                    <select id="transactionType" required>
                        <option value="buy">Compra</option>
                        <option value="sell">Venta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ticker</label>
                    <input type="text" id="ticker" placeholder="Ej: AAPL, GOOGL, DECK" required style="text-transform: uppercase;" oninput="autoDetectRatio()">
                </div>
                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="quantity" placeholder="0" step="1" min="1" required>
                </div>
                <div class="form-group">
                    <label>Precio (ARS)</label>
                    <input type="number" id="price" placeholder="0.00" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label>Ratio de Conversi√≥n <span id="ratioStatus" style="font-size: 12px;"></span></label>
                    <input type="number" id="ratio" placeholder="1" step="1" min="1" value="1">
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
                        <span id="ratioHelp">Se detecta autom√°ticamente. 294 CEDEARs en base de datos.</span>
                    </small>
                </div>
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" id="transactionDate" required>
                </div>
                <div class="form-group">
                    <label>CCL de la operaci√≥n (ARS/USD) <span id="cclSuggest" style="font-size: 12px; color: #94a3b8;"></span></label>
                    <input type="number" id="transactionCCL" placeholder="0.00" step="0.01" min="0.01">
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 5px;">
                        Se sugiere autom√°ticamente seg√∫n la fecha, pero pod√©s editarlo siempre.
                    </small>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // CEDEAR Ratios Database - Automatically loaded from Excel (294 CEDEARs)
        const CEDEAR_RATIOS = {
            // RATIOS OFICIALES - Fuente: Banco Comafi + Usuario (Diciembre 2024)
            // Total: 316 CEDEARs (305 Comafi + 11 adicionales)
            "AABA": 3, "AAL": 2, "AAP": 14, "AAPL": 20, "ABBV": 10, "ABEV": 1, "ABT": 4, "ACN": 75, 
            "ADBE": 44, "ADI": 15, "ADP": 6, "ADS": 22, "AEG": 1, "AEM": 6, "AGRO": 1, "AIG": 5, 
            "AKO.B": 1, "AMAT": 5, "AMD": 10, "AMGN": 30, "AMX": 1, "AMZN": 144, "ANF": 1, 
            "ARCO": 1, "ARM": 27, "ASML": 146, "ASR": 20, "ATAD": 4, "AVGO": 39, "AVY": 18, 
            "AXP": 15, "AZN": 2, "BA": 24, "BABA": 9, "BAC": 4, "BAK": 2, "BAS GR": 2, 
            "BAYN GR": 3, "BB": 3, "BBD": 1, "BBVA": 1, "BCS": 1, "BG": 5, "BHP": 2, "BIDU": 1, 
            "BIIB": 13, "BIOX": 1, "BITI": 20, "BK": 2, "BKNG": 700, "BKR": 7, "BMY": 3, "BP": 5, 
            "BRFS": 1, "BRK/B": 22, "BSBR": 1, "BSN GR": 20, "C": 3, "CAAP": 1, "CAH": 3, 
            "CAR": 26, "CAT": 20, "CBD": 1, "CCL": 3, "CDE": 1, "CL": 3, "COIN": 27, "COST": 48, 
            "CRM": 18, "CSCO": 5, "CVS": 15, "CVX": 16, "CX": 1, "DAL": 8, "DD": 5, "DE": 40, 
            "DEO": 6, "DESP": 1, "DIA": 20, "DIS": 12, "DJNJ3-XD004": 1, "DOCU": 22, "DOW": 6, 
            "DTEA GR": 3, "E": 4, "EA": 14, "EBAY": 2, "EBR": 1, "EFX": 16, "ELP": 1, "EOAN GR": 6, 
            "EQNR": 6, "ERIC": 2, "ERJ": 1, "ETSY": 16, "FCX": 3, "FDX": 10, "FMCC": 1, "FMX": 6, 
            "FNMA": 1, "FSLR": 18, "FXI": 5, "GE": 8, "GFI": 1, "GGB": 1, "GILD": 4, "GLD": 50, 
            "GLOB": 18, "GLW": 4, "GM": 6, "GOLD": 2, "GOOGL": 58, "GPRK": 1, "GRMN": 3, "GS": 13, 
            "GSK": 4, "GT": 2, "HAL": 2, "HD": 32, "HDB": 2, "HHPD LI": 2, "HL": 1, "HMC": 1, 
            "HMY": 1, "HOG": 3, "HON": 8, "HPQ": 1, "HSBC": 2, "HSY": 21, "HWM": 1, "IBB": 27, 
            "IBIT": 10, "IBM": 15, "IBN": 1, "IEUR": 11, "IFF": 12, "INFY": 1, "ING": 3, "INTC": 5, 
            "IP": 4, "ISRG": 90, "ITUB": 1, "IVE": 40, "IVW": 20, "JCI": 2, "JD": 4, "JNJ": 15, 
            "JPM": 15, "KB": 2, "KEP": 1, "KGC": 1, "KMB": 6, "KO": 5, "KOF": 2, "LAC": 1, 
            "LAR": 1, "LKOD": 4, "LLY": 56, "LMT": 20, "LND": 1, "LRCX": 56, "LVS": 2, "LYG": 2, 
            "MA": 33, "MBG GR": 4, "MBT": 2, "MCD": 24, "MDLZ": 15, "MDT": 4, "MELI": 120, 
            "META": 24, "MFG": 1, "MMC": 16, "MMM": 10, "MO": 4, "MRK": 5, "MRNA": 19, "MRVL": 14, 
            "MSFT": 30, "MSI": 20, "MSTR": 20, "MUFG": 1, "MUX": 2, "NEC1 GR": 1, "NEM": 3, 
            "NFLX": 48, "NG": 1, "NGG": 2, "NIO": 4, "NKE": 12, "NLMK LI": 2, "NMR": 1, "NOK": 1, 
            "NSANY": 1, "NTES": 14, "NU": 2, "NUE": 16, "NVDA": 24, "NVS": 4, "NXE": 1, "OGZD": 2, 
            "ORANY": 1, "ORCL": 3, "ORLY": 222, "PAAS": 3, "PAC": 16, "PAGS": 3, "PANW": 50, 
            "PBI": 1, "PBR": 1, "PCAR": 3, "PEP": 18, "PFE": 4, "PG": 15, "PHG": 5, "PINS": 7, 
            "PKX": 3, "PLTR": 3, "PM": 18, "PSO": 1, "PSX": 6, "PYPL": 8, "QCOM": 11, "QQQ": 20, 
            "RACE": 83, "RGTI": 2, "RIO": 8, "RIOT": 3, "ROKU": 13, "ROST": 4, "RTX": 5, "SAN": 1, 
            "SAP": 6, "SATL": 1, "SBS": 1, "SBUX": 12, "SCCO": 2, "SCHW": 13, "SDA": 2, "SE": 32, 
            "SHEL": 2, "SHOP": 107, "SHPW": 1, "SID": 1, "SIEGY": 3, "SLB": 3, "SMSN LI": 14, 
            "SNA": 6, "SNAP": 1, "SNOW": 30, "SONY": 8, "SPCE": 1, "SPGI": 45, "SPOT": 28, 
            "SPY": 20, "STLA": 5, "STNE": 3, "SUZ": 1, "SWKS": 21, "SYY": 8, "T": 3, "TCOM": 2, 
            "TEF": 8, "TGT": 24, "TIIAY": 1, "TIMB": 1, "TJX": 22, "TM": 15, "TMO": 22, "TMUS": 33, 
            "TRIP": 2, "TRV": 6, "TS": 1, "TSLA": 15, "TSM": 9, "TTE": 3, "TV": 3, "TWLO": 36, 
            "TX": 4, "TXN": 5, "UBER": 2, "UGP": 1, "UL": 3, "UNH": 33, "UNP": 20, "URBN": 2, 
            "USB": 5, "V": 18, "VALE": 2, "VEA": 10, "VIST": 3, "VIV": 1, "VOD": 1, "VRSN": 6, 
            "VZ": 4, "WB": 6, "WBA": 3, "WFC": 5, "WMT": 18, "X": 3, "XLB": 18, "XLC": 19, 
            "XLI": 28, "XLK": 46, "XLP": 16, "XLRE": 9, "XLV": 29, "XLY": 43, "XOM": 10, "XP": 4, 
            "XRX": 1, "XYZ": 20, "YELP": 2, "YY": 5, "YZCAY": 2, "ZM": 47 
        };

        // Initial data from user's backup (loaded if localStorage is empty)
        const INITIAL_PORTFOLIO_DATA = [
  {
    "id": 1765560220140,
    "type": "buy",
    "ticker": "UBER",
    "quantity": 12,
    "price": 62650,
    "ratio": 2,
    "cclRate": 1508.2,
    "date": "2025-12-10",
    "timestamp": "2025-12-12T17:23:40.482Z"
  },
  {
    "id": 1765560313189,
    "type": "buy",
    "ticker": "NVDA",
    "quantity": 76,
    "price": 11470,
    "ratio": 24,
    "cclRate": 1508.2,
    "date": "2025-12-01",
    "timestamp": "2025-12-12T17:25:13.189Z"
  },
  {
    "id": 1765569035539,
    "type": "buy",
    "ticker": "MSTR",
    "quantity": 30,
    "price": 26580,
    "ratio": 20,
    "cclRate": 1511.2,
    "date": "2025-09-19",
    "timestamp": "2025-12-12T19:50:35.573Z"
  },
  {
    "id": 1765569124073,
    "type": "buy",
    "ticker": "RGTI",
    "quantity": 4,
    "price": 34680,
    "ratio": 1,
    "cclRate": 1511.2,
    "date": "2025-10-07",
    "timestamp": "2025-12-12T19:52:04.073Z"
  },
  {
    "id": 1765570656364,
    "type": "buy",
    "ticker": "BIOX",
    "quantity": 13,
    "price": 7950,
    "ratio": 1,
    "cclRate": 1512.2,
    "date": "2024-11-26",
    "timestamp": "2025-12-12T20:17:36.365Z"
  },
  {
    "id": 1765570706663,
    "type": "buy",
    "ticker": "MSTR",
    "quantity": 7,
    "price": 27140,
    "ratio": 20,
    "cclRate": 1512.2,
    "date": "2025-10-06",
    "timestamp": "2025-12-12T20:18:26.663Z"
  },
  {
    "id": 1765570826411,
    "type": "buy",
    "ticker": "NKE",
    "quantity": 21,
    "price": 10020,
    "ratio": 12,
    "cclRate": 1512.2,
    "date": "2025-10-02",
    "timestamp": "2025-12-12T20:20:26.411Z"
  },
  {
    "id": 1765571869028,
    "type": "buy",
    "ticker": "IBIT",
    "quantity": 39,
    "price": 8090,
    "ratio": 10,
    "cclRate": 1512.2,
    "date": "2025-11-27",
    "timestamp": "2025-12-12T20:37:49.029Z"
  },
  {
    "id": 1765571930699,
    "type": "buy",
    "ticker": "ORCL",
    "quantity": 9,
    "price": 94025,
    "ratio": 3,
    "cclRate": 1512.2,
    "date": "2025-12-12",
    "timestamp": "2025-12-12T20:38:50.699Z"
  },
  {
    "id": 1765572071607,
    "type": "buy",
    "ticker": "SATL",
    "quantity": 303,
    "price": 3293,
    "ratio": 1,
    "cclRate": 1512.2,
    "date": "2025-12-12",
    "timestamp": "2025-12-12T20:41:11.607Z"
  },
  {
    "id": 1765572118114,
    "type": "buy",
    "ticker": "ADBE",
    "quantity": 44,
    "price": 11540,
    "ratio": 44,
    "cclRate": 1512.2,
    "date": "2025-10-31",
    "timestamp": "2025-12-12T20:41:58.114Z"
  },
  {
    "id": 1765572210813,
    "type": "buy",
    "ticker": "BITI",
    "quantity": 10,
    "price": 35928,
    "ratio": 20,
    "cclRate": 1512.2,
    "date": "2025-12-01",
    "timestamp": "2025-12-12T20:43:30.813Z"
  },
  {
    "id": 1765572251272,
    "type": "buy",
    "ticker": "BITI",
    "quantity": 7,
    "price": 33000,
    "ratio": 20,
    "cclRate": 1512.2,
    "date": "2025-12-09",
    "timestamp": "2025-12-12T20:44:11.273Z"
  },
  {
    "id": 1765572304668,
    "type": "buy",
    "ticker": "V",
    "quantity": 1,
    "price": 27820,
    "ratio": 18,
    "cclRate": 1512.2,
    "date": "2025-09-16",
    "timestamp": "2025-12-12T20:45:04.668Z"
  },
  {
    "id": 1765572350731,
    "type": "buy",
    "ticker": "V",
    "quantity": 21,
    "price": 27280,
    "ratio": 18,
    "cclRate": 1512.2,
    "date": "2025-11-14",
    "timestamp": "2025-12-12T20:45:50.731Z"
  },
  {
    "id": 1765572456582,
    "type": "buy",
    "ticker": "AVGO",
    "quantity": 27,
    "price": 13960,
    "ratio": 39,
    "cclRate": 1512.2,
    "date": "2025-12-12",
    "timestamp": "2025-12-12T20:47:36.582Z"
  },
  {
    "id": 1765572488347,
    "type": "buy",
    "ticker": "XP",
    "quantity": 46,
    "price": 6690,
    "ratio": 4,
    "cclRate": 1512.2,
    "date": "2025-12-12",
    "timestamp": "2025-12-12T20:48:08.347Z"
  },
  {
    "id": 1765586959557,
    "type": "buy",
    "ticker": "YPF",
    "quantity": 31,
    "price": 40578,
    "ratio": 1,
    "cclRate": 1512.2,
    "date": "2025-09-18",
    "timestamp": "2025-12-13T00:49:19.557Z"
  },
  {
    "id": 1765587023871,
    "type": "sell",
    "ticker": "YPF",
    "quantity": 31,
    "price": 50700,
    "ratio": 1,
    "cclRate": 1512.2,
    "date": "2025-10-14",
    "timestamp": "2025-12-13T00:50:23.871Z"
  }
];

        // Data storage - Load from localStorage or use initial data
        let transactions = JSON.parse(localStorage.getItem('transactions')) || INITIAL_PORTFOLIO_DATA;
        
        // Save initial data to localStorage if it was loaded from INITIAL_PORTFOLIO_DATA
        if (!localStorage.getItem('transactions') && INITIAL_PORTFOLIO_DATA.length > 0) {
            localStorage.setItem('transactions', JSON.stringify(INITIAL_PORTFOLIO_DATA));
            console.log('üì¶ Loaded initial portfolio data (' + INITIAL_PORTFOLIO_DATA.length + ' transactions)');
        }
        
        let customRatios = JSON.parse(localStorage.getItem('customRatios')) || {}; // NEW: Store user-defined ratios
        let lastUpdateTime = Date.now();
        
        // ===============================================
        // SISTEMA H√çBRIDO INTELIGENTE - v16
        // ===============================================
        
        // Alpha Vantage API Key
        const ALPHA_VANTAGE_KEY = 'XYA4EPU46J3ZV2PZ'; // 500 llamadas/d√≠a
        
        // Contador de llamadas API (reset diario)
        function getAPICallsToday() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem('apiCallsDate');
            
            if (stored !== today) {
                // Nuevo d√≠a, reset contador
                localStorage.setItem('apiCallsDate', today);
                localStorage.setItem('apiCallsCount', '0');
                return 0;
            }
            
            return parseInt(localStorage.getItem('apiCallsCount') || '0');
        }
        
        function incrementAPICall() {
            const current = getAPICallsToday();
            localStorage.setItem('apiCallsCount', (current + 1).toString());
            updateAPICounter();
            return current + 1;
        }
        
        function getRemainingAPICalls() {
            return 500 - getAPICallsToday();
        }
        
        function updateAPICounter() {
            // Actualizar contador en UI si existe
            const counter = document.getElementById('apiCallsCounter');
            if (counter) {
                const used = getAPICallsToday();
                const remaining = getRemainingAPICalls();
                counter.textContent = `${used}/500 llamadas (${remaining} disponibles)`;
                
                // Cambiar color seg√∫n disponibilidad
                if (remaining < 50) counter.style.color = '#ef4444'; // Rojo
                else if (remaining < 150) counter.style.color = '#f59e0b'; // Amarillo
                else counter.style.color = '#10b981'; // Verde
            }
        }
        
        // Sistema de Cache para datos hist√≥ricos
        function getCachedPrice(ticker, mes) {
            const cacheKey = `price_${ticker}_${mes}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                const data = JSON.parse(cached);
                // Cache v√°lido por 30 d√≠as
                if (Date.now() - data.timestamp < 30 * 24 * 60 * 60 * 1000) {
                    return { price: data.price, source: 'cache' };
                }
            }
            return null;
        }
        
        function setCachedPrice(ticker, mes, price) {
            const cacheKey = `price_${ticker}_${mes}`;
            localStorage.setItem(cacheKey, JSON.stringify({
                price: price,
                timestamp: Date.now()
            }));
        }
        
        // Funci√≥n H√çBRIDA: Intenta Yahoo primero, luego Alpha Vantage
        async function obtenerPrecioHistoricoHibrido(ticker, fecha) {
            // fecha formato: "YYYY-MM" (ej: "2024-01")
            
            // 1. Intentar CACHE primero
            const cached = getCachedPrice(ticker, fecha);
            if (cached) {
                console.log(`üü¢ [CACHE] ${ticker} ${fecha}: $${cached.price}`);
                return cached;
            }
            
            // 2. Intentar YAHOO FINANCE (ilimitado)
            try {
                const yahooPrice = await obtenerPrecioYahooHistorico(ticker, fecha);
                if (yahooPrice !== null) {
                    setCachedPrice(ticker, fecha, yahooPrice);
                    console.log(`üü¢ [YAHOO] ${ticker} ${fecha}: $${yahooPrice}`);
                    return { price: yahooPrice, source: 'yahoo' };
                }
            } catch (e) {
                console.log(`‚ö†Ô∏è Yahoo fall√≥ para ${ticker} ${fecha}`);
            }
            
            // 3. Intentar ALPHA VANTAGE (solo si Yahoo falla)
            if (getRemainingAPICalls() > 0) {
                try {
                    const alphaPrice = await obtenerPrecioAlphaHistorico(ticker, fecha);
                    if (alphaPrice !== null) {
                        setCachedPrice(ticker, fecha, alphaPrice);
                        incrementAPICall();
                        console.log(`üü° [ALPHA] ${ticker} ${fecha}: $${alphaPrice} (${getRemainingAPICalls()} llamadas restantes)`);
                        return { price: alphaPrice, source: 'alpha' };
                    }
                } catch (e) {
                    console.log(`‚ùå Alpha fall√≥ para ${ticker} ${fecha}`);
                }
            } else {
                console.log(`üî¥ Sin llamadas API disponibles hoy`);
            }
            
            // 4. ESTIMACI√ìN (√∫ltimo recurso)
            console.log(`üî¥ [ESTIMADO] ${ticker} ${fecha} - usando precio actual`);
            return { price: null, source: 'estimated' };
        }
        
        // Yahoo Finance: Obtener precio hist√≥rico de un mes espec√≠fico
        async function obtenerPrecioYahooHistorico(ticker, mes) {
            // mes = "YYYY-MM"
            const [year, month] = mes.split('-').map(Number);
            
            // Calcular timestamps para el mes completo
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0); // √öltimo d√≠a del mes
            
            const startTimestamp = Math.floor(startDate.getTime() / 1000);
            const endTimestamp = Math.floor(endDate.getTime() / 1000);
            
            const proxies = [
                'https://corsproxy.io/?',
                'https://api.codetabs.com/v1/proxy?quest=',
                'https://api.allorigins.win/raw?url='
            ];
            
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?period1=${startTimestamp}&period2=${endTimestamp}&interval=1d`;
            
            for (let proxy of proxies) {
                try {
                    const url = proxy + encodeURIComponent(yahooUrl);
                    const r = await fetch(url);
                    if (!r.ok) continue;
                    
                    const data = await r.json();
                    if (data.chart && data.chart.result && data.chart.result[0]) {
                        const closes = data.chart.result[0].indicators.quote[0].close;
                        const validCloses = closes.filter(c => c !== null && !isNaN(c));
                        
                        if (validCloses.length > 0) {
                            // Promedio del mes
                            const avgPrice = validCloses.reduce((a, b) => a + b, 0) / validCloses.length;
                            return avgPrice;
                        }
                    }
                } catch (e) {
                    continue;
                }
            }
            
            return null;
        }
        
        // Alpha Vantage: Obtener precio hist√≥rico mensual
        async function obtenerPrecioAlphaHistorico(ticker, mes) {
            // mes = "YYYY-MM"
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_MONTHLY&symbol=${ticker}&apikey=${ALPHA_VANTAGE_KEY}`;
            
            try {
                const r = await fetch(url);
                const data = await r.json();
                
                if (data['Error Message'] || data['Note']) {
                    return null;
                }
                
                const monthly = data['Monthly Time Series'];
                if (monthly && monthly[mes + '-01']) {
                    return parseFloat(monthly[mes + '-01']['4. close']);
                }
                
                // Si no hay dato exacto, buscar el mes m√°s cercano
                const dates = Object.keys(monthly || {}).sort().reverse();
                for (let date of dates) {
                    if (date.startsWith(mes)) {
                        return parseFloat(monthly[date]['4. close']);
                    }
                }
                
                return null;
            } catch (e) {
                return null;
            }
        }
        
        // Chart instances
        let chartInstances = {
            portfolio: null,
            market: null,
            sector: null,
            value: null
        };
        let currentValueChartCurrency = 'ARS';

        // Sector database for major tickers
        const TICKER_SECTORS = {
            // Technology
            "AAPL": "Tecnolog√≠a", "GOOGL": "Tecnolog√≠a", "MSFT": "Tecnolog√≠a", "NVDA": "Tecnolog√≠a",
            "AMD": "Tecnolog√≠a", "INTC": "Tecnolog√≠a", "TSLA": "Tecnolog√≠a", "META": "Tecnolog√≠a",
            "NFLX": "Tecnolog√≠a", "ADBE": "Tecnolog√≠a", "CRM": "Tecnolog√≠a", "ORCL": "Tecnolog√≠a",
            "AVGO": "Tecnolog√≠a", "QCOM": "Tecnolog√≠a", "TXN": "Tecnolog√≠a", "ASML": "Tecnolog√≠a",
            // Communication
            "T": "Comunicaci√≥n", "VZ": "Comunicaci√≥n", "TMUS": "Comunicaci√≥n", "DIS": "Comunicaci√≥n",
            "CMCSA": "Comunicaci√≥n", "CHTR": "Comunicaci√≥n",
            // Consumer Discretionary
            "AMZN": "Consumo discrecional", "NKE": "Consumo discrecional", "MCD": "Consumo discrecional",
            "SBUX": "Consumo discrecional", "HD": "Consumo discrecional", "LOW": "Consumo discrecional",
            "TGT": "Consumo discrecional", "BKNG": "Consumo discrecional", "MELI": "Consumo discrecional",
            // Consumer Staples
            "KO": "Consumo b√°sico", "PEP": "Consumo b√°sico", "WMT": "Consumo b√°sico", "COST": "Consumo b√°sico",
            "PG": "Consumo b√°sico", "UL": "Consumo b√°sico",
            // Healthcare
            "JNJ": "Salud", "PFE": "Salud", "UNH": "Salud", "ABBV": "Salud", "TMO": "Salud",
            "ABT": "Salud", "DHR": "Salud", "MRK": "Salud", "LLY": "Salud",
            // Financials
            "JPM": "Finanzas", "BAC": "Finanzas", "WFC": "Finanzas", "C": "Finanzas", "GS": "Finanzas",
            "MS": "Finanzas", "AXP": "Finanzas", "BLK": "Finanzas", "V": "Finanzas", "MA": "Finanzas",
            "PYPL": "Finanzas", "SCHW": "Finanzas",
            // Industrials
            "BA": "Industria", "CAT": "Industria", "GE": "Industria", "HON": "Industria",
            "MMM": "Industria", "UPS": "Industria", "RTX": "Industria", "LMT": "Industria",
            "DE": "Industria", "UNP": "Industria", "UAL": "Industria", "DAL": "Industria",
            // Energy
            "XOM": "Energ√≠a", "CVX": "Energ√≠a", "COP": "Energ√≠a", "SLB": "Energ√≠a", "EOG": "Energ√≠a",
            // Materials
            "LIN": "Materiales b√°sicos", "APD": "Materiales b√°sicos", "ECL": "Materiales b√°sicos",
            "DD": "Materiales b√°sicos", "NEM": "Materiales b√°sicos",
            // Real Estate
            "AMT": "Real Estate", "PLD": "Real Estate", "CCI": "Real Estate", "EQIX": "Real Estate",
            // Utilities
            "NEE": "Servicios p√∫blicos", "DUK": "Servicios p√∫blicos", "SO": "Servicios p√∫blicos",
            // Transportation
            "UBER": "Transporte", "LYFT": "Transporte",
            // E-commerce/Retail
            "EBAY": "E-commerce", "ETSY": "E-commerce", "SE": "E-commerce",
            // Crypto/Fintech
            "SQ": "Fintech", "COIN": "Cripto", "HOOD": "Fintech", "SOFI": "Fintech",
            // Entertainment/Gaming
            "EA": "Entretenimiento", "ATVI": "Entretenimiento", "TTWO": "Entretenimiento",
            // Other major
            "BRK.B": "Conglomerado", "SPY": "ETF", "QQQ": "ETF", "IWM": "ETF", "DIA": "ETF",
            "VTI": "ETF", "VOO": "ETF", "VT": "ETF",
            // International
            "BABA": "Tecnolog√≠a", "TSM": "Tecnolog√≠a", "NIO": "Tecnolog√≠a",
            // More stocks
            "IBM": "Tecnolog√≠a", "PANW": "Tecnolog√≠a", "SNOW": "Tecnolog√≠a", "ZS": "Tecnolog√≠a",
            "MSTR": "Tecnolog√≠a", "COIN": "Cripto", "RGTI": "Tecnolog√≠a", "BIOX": "Salud",
            "COME": "Servicios p√∫blicos", "SATL": "Tecnolog√≠a", "GLD": "Commodities",
            "LLY": "Salud", "IBIT": "ETF", "AMGN": "Salud", "CAT": "Industria",
            "MSI": "Tecnolog√≠a", "SPY": "ETF", "KO": "Consumo b√°sico", "MO": "Consumo b√°sico",
            "BAC": "Finanzas", "RGTI": "Tecnolog√≠a", "T": "Comunicaci√≥n", "BIOX": "Salud",
            "SBUX": "Consumo discrecional"
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Portfolio Manager Pro v23 - Starting...');
            console.log('üí° Open the browser console (F12) to see detailed price fetching logs');
            
            // Pre-load transactions if localStorage is empty
            const existingTransactions = localStorage.getItem('transactions');
            if (!existingTransactions || existingTransactions === '[]') {
                console.log('üì• Pre-cargando transacciones desde backup...');
                const preloadedTransactions = [{"id":1765664305850.5479,"type":"buy","ticker":"ADBE","quantity":12,"price":11750,"ratio":44,"cclRate":1097,"date":"2024-12-16","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.374,"type":"buy","ticker":"ADBE","quantity":28,"price":10775,"ratio":44,"cclRate":1271,"date":"2025-07-10","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.0605,"type":"buy","ticker":"ADBE","quantity":67,"price":10125,"ratio":44,"cclRate":1328,"date":"2025-08-07","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.9504,"type":"buy","ticker":"MSI","quantity":8,"price":25075,"ratio":20,"cclRate":1211,"date":"2025-05-06","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.6587,"type":"buy","ticker":"AMGN","quantity":7,"price":14625,"ratio":30,"cclRate":1332,"date":"2024-07-18","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.771,"type":"buy","ticker":"KO","quantity":5,"price":17850,"ratio":5,"cclRate":1245,"date":"2024-09-09","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5925,"type":"buy","ticker":"MSFT","quantity":5,"price":16450,"ratio":30,"cclRate":1018,"date":"2024-10-28","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.207,"type":"buy","ticker":"SBUX","quantity":2,"price":6899,"ratio":12,"cclRate":1099,"date":"2024-05-16","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.519,"type":"buy","ticker":"LLY","quantity":5,"price":21125,"ratio":56,"cclRate":1308,"date":"2024-07-17","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.1755,"type":"buy","ticker":"GOOGL","quantity":1,"price":3180,"ratio":58,"cclRate":1158,"date":"2025-05-13","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.4114,"type":"buy","ticker":"NVDA","quantity":1,"price":7359,"ratio":24,"cclRate":1392,"date":"2024-07-05","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.9612,"type":"buy","ticker":"GOOGL","quantity":2,"price":3625,"ratio":58,"cclRate":1025,"date":"2024-11-07","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.7163,"type":"buy","ticker":"MSI","quantity":1,"price":20158,"ratio":20,"cclRate":1231,"date":"2024-01-29","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.8132,"type":"buy","ticker":"MSI","quantity":1,"price":20907,"ratio":20,"cclRate":1293,"date":"2024-02-05","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.597,"type":"buy","ticker":"NVDA","quantity":1,"price":6000,"ratio":24,"cclRate":1294,"date":"2024-07-29","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.6138,"type":"buy","ticker":"MSFT","quantity":1,"price":10232,"ratio":30,"cclRate":868,"date":"2023-11-03","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5615,"type":"buy","ticker":"GLD","quantity":5,"price":7360,"ratio":50,"cclRate":1195,"date":"2025-06-11","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.954,"type":"buy","ticker":"MSI","quantity":2,"price":17978,"ratio":20,"cclRate":1096,"date":"2024-02-26","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.3252,"type":"buy","ticker":"QQQ","quantity":1,"price":29500,"ratio":20,"cclRate":1211,"date":"2025-05-06","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.1458,"type":"buy","ticker":"DIA","quantity":1,"price":12925,"ratio":20,"cclRate":746,"date":"2023-08-23","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.6733,"type":"buy","ticker":"DIA","quantity":1,"price":12925,"ratio":20,"cclRate":746,"date":"2023-08-23","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.4192,"type":"buy","ticker":"DIA","quantity":1,"price":12787,"ratio":20,"cclRate":741,"date":"2023-09-08","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.9746,"type":"buy","ticker":"NVDA","quantity":2,"price":5860,"ratio":24,"cclRate":1341,"date":"2024-08-06","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5938,"type":"buy","ticker":"LLY","quantity":5,"price":20000,"ratio":56,"cclRate":1332,"date":"2024-07-18","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.506,"type":"buy","ticker":"MSFT","quantity":2,"price":11745,"ratio":30,"cclRate":946,"date":"2023-12-18","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.0168,"type":"buy","ticker":"V","quantity":3,"price":17898,"ratio":18,"cclRate":1144,"date":"2024-02-19","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.135,"type":"buy","ticker":"AMZN","quantity":209,"price":2215,"ratio":144,"cclRate":1475,"date":"2025-10-14","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.3171,"type":"buy","ticker":"MSFT","quantity":2,"price":10232,"ratio":30,"cclRate":868,"date":"2023-11-03","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5354,"type":"buy","ticker":"NVDA","quantity":4,"price":7690,"ratio":24,"cclRate":1427,"date":"2024-07-12","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.33,"type":"buy","ticker":"BAC","quantity":2,"price":10052,"ratio":4,"cclRate":1193,"date":"2024-01-09","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.2832,"type":"buy","ticker":"QQQ","quantity":1,"price":20162,"ratio":20,"cclRate":997,"date":"2023-12-15","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.1372,"type":"buy","ticker":"SPY","quantity":1,"price":17388,"ratio":20,"cclRate":787,"date":"2023-08-28","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.1672,"type":"buy","ticker":"SPY","quantity":1,"price":17388,"ratio":20,"cclRate":787,"date":"2023-08-28","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.0408,"type":"buy","ticker":"DIA","quantity":2,"price":11537,"ratio":20,"cclRate":654,"date":"2023-08-14","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.1978,"type":"buy","ticker":"MSI","quantity":4,"price":20158,"ratio":20,"cclRate":1231,"date":"2024-01-29","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.9434,"type":"buy","ticker":"QQQ","quantity":1,"price":15100,"ratio":20,"cclRate":788,"date":"2023-08-29","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5715,"type":"buy","ticker":"QQQ","quantity":1,"price":15100,"ratio":20,"cclRate":788,"date":"2023-08-29","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.4067,"type":"buy","ticker":"BA","quantity":1,"price":11350,"ratio":6,"cclRate":1022,"date":"2024-11-04","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.8843,"type":"buy","ticker":"SPY","quantity":4,"price":13197,"ratio":20,"cclRate":591,"date":"2023-08-09","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.651,"type":"buy","ticker":"AMD","quantity":7,"price":20000,"ratio":10,"cclRate":1232,"date":"2024-10-03","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5632,"type":"buy","ticker":"GOOGL","quantity":37,"price":3545,"ratio":58,"cclRate":1024,"date":"2024-11-05","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.3428,"type":"buy","ticker":"AMD","quantity":5,"price":13875,"ratio":10,"cclRate":1072,"date":"2024-12-09","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5364,"type":"buy","ticker":"NVDA","quantity":22,"price":6810,"ratio":24,"cclRate":1291,"date":"2024-08-28","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.2212,"type":"buy","ticker":"NVDA","quantity":17,"price":5500,"ratio":24,"cclRate":1327,"date":"2024-08-07","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.199,"type":"buy","ticker":"AMD","quantity":7,"price":15300,"ratio":10,"cclRate":1164,"date":"2025-01-07","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.345,"type":"buy","ticker":"NVDA","quantity":36,"price":6210,"ratio":24,"cclRate":1104,"date":"2024-11-27","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.436,"type":"buy","ticker":"CAT","quantity":8,"price":21775,"ratio":20,"cclRate":1188,"date":"2025-02-04","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.744,"type":"buy","ticker":"PANW","quantity":108,"price":4590,"ratio":50,"cclRate":1334,"date":"2025-08-06","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.9197,"type":"buy","ticker":"IBM","quantity":22,"price":22525,"ratio":15,"cclRate":1334,"date":"2025-08-06","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.0898,"type":"buy","ticker":"GOOGL","quantity":52,"price":3820,"ratio":58,"cclRate":1187,"date":"2025-02-13","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.6042,"type":"buy","ticker":"NVDA","quantity":25,"price":5490,"ratio":24,"cclRate":1302,"date":"2024-09-03","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.2676,"type":"buy","ticker":"GOOGL","quantity":47,"price":3230,"ratio":58,"cclRate":1109,"date":"2024-11-29","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.7678,"type":"buy","ticker":"ASML","quantity":100,"price":6590,"ratio":146,"cclRate":1334,"date":"2025-08-11","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.8853,"type":"buy","ticker":"MSI","quantity":1,"price":29060,"ratio":20,"cclRate":1473,"date":"2025-11-12","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5981,"type":"buy","ticker":"AAL","quantity":5,"price":7530,"ratio":2,"cclRate":1302,"date":"2024-08-01","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.9731,"type":"buy","ticker":"AAL","quantity":3,"price":6730,"ratio":2,"cclRate":1367,"date":"2025-08-01","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.8716,"type":"buy","ticker":"MSTR","quantity":30,"price":26580,"ratio":20,"cclRate":1496,"date":"2025-09-19","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.273,"type":"buy","ticker":"UBER","quantity":12,"price":62650,"ratio":2,"cclRate":1502,"date":"2025-12-10","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.0312,"type":"buy","ticker":"NVDA","quantity":76,"price":11470,"ratio":24,"cclRate":1502,"date":"2025-12-10","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5093,"type":"buy","ticker":"BIOX","quantity":13,"price":7950,"ratio":1,"cclRate":1130,"date":"2024-11-26","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.3516,"type":"buy","ticker":"MSTR","quantity":7,"price":27140,"ratio":20,"cclRate":1517,"date":"2025-10-06","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.7842,"type":"buy","ticker":"NKE","quantity":21,"price":10020,"ratio":12,"cclRate":1573,"date":"2025-10-02","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.1116,"type":"buy","ticker":"IBIT","quantity":39,"price":8090,"ratio":10,"cclRate":1532,"date":"2025-11-27","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.777,"type":"buy","ticker":"ORCL","quantity":9,"price":94025,"ratio":3,"cclRate":1505,"date":"2025-12-11","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.0046,"type":"buy","ticker":"RGTI","quantity":4,"price":34680,"ratio":2,"cclRate":1556,"date":"2025-10-07","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.333,"type":"buy","ticker":"SATL","quantity":303,"price":3293,"ratio":1,"cclRate":1503,"date":"2025-12-11","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.4187,"type":"buy","ticker":"ADBE","quantity":44,"price":11540,"ratio":44,"cclRate":1500,"date":"2025-10-31","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5178,"type":"buy","ticker":"BITI","quantity":10,"price":35928,"ratio":20,"cclRate":1497,"date":"2025-12-01","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.4277,"type":"buy","ticker":"BITI","quantity":7,"price":33000,"ratio":20,"cclRate":1508,"date":"2025-12-09","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5771,"type":"buy","ticker":"V","quantity":1,"price":27820,"ratio":18,"cclRate":1478,"date":"2025-09-16","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.109,"type":"buy","ticker":"V","quantity":21,"price":27280,"ratio":18,"cclRate":1497,"date":"2025-11-14","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.4326,"type":"buy","ticker":"AVGO","quantity":27,"price":13960,"ratio":39,"cclRate":1509,"date":"2025-12-12","timestamp":"2025-12-13T22:18:25.850Z"},{"id":1765664305850.5127,"type":"buy","ticker":"XP","quantity":46,"price":6690,"ratio":4,"cclRate":1509,"date":"2025-12-12","timestamp":"2025-12-13T22:18:25.850Z"}];
                localStorage.setItem('transactions', JSON.stringify(preloadedTransactions));
                console.log('‚úÖ Pre-cargadas ' + preloadedTransactions.length + ' transacciones');
            }
            
            // Set today's date as default
            document.getElementById('transactionDate').valueAsDate = new Date();
            
            // Show loading message
            const tbody = document.getElementById('portfolioBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">üìä Cargando precios en tiempo real...</td></tr>';
            
            // Load data
            console.log('üìÇ Loading portfolio data...');
            updatePortfolio();
            updateTransactionsList();
            updateVentas();
            updateLastUpdateTime();
            
            // Update prices every 2 minutes
            setInterval(() => {
                console.log('\nüîÑ Automatic price update...');
                updatePortfolio();
                updateLastUpdateTime();
            }, 120000);

            // Update timer every minute
            setInterval(updateLastUpdateTime, 60000);
        });

        // Auto-detect CEDEAR ratio based on ticker
        function autoDetectRatio() {
            const ticker = document.getElementById('ticker').value.toUpperCase().trim();
            const ratioInput = document.getElementById('ratio');
            const ratioStatus = document.getElementById('ratioStatus');
            const ratioHelp = document.getElementById('ratioHelp');
            
            if (!ticker) {
                ratioInput.value = 1;
                ratioInput.style.background = '';
                ratioStatus.textContent = '';
                ratioHelp.textContent = 'Se detecta autom√°ticamente. 294 CEDEARs en base de datos.';
                ratioHelp.style.color = '#6b7280';
                return;
            }
            
            // First check custom ratios (user-defined)
            if (customRatios[ticker]) {
                ratioInput.value = customRatios[ticker];
                ratioInput.style.background = 'rgba(139, 92, 246, 0.1)';
                ratioStatus.textContent = `‚úì Ratio ${customRatios[ticker]}:1 (personalizado)`;
                ratioStatus.style.color = '#8b5cf6';
                ratioHelp.textContent = 'Ratio guardado previamente por ti.';
                ratioHelp.style.color = '#8b5cf6';
                return;
            }
            
            // Then check database
            if (CEDEAR_RATIOS[ticker]) {
                ratioInput.value = CEDEAR_RATIOS[ticker];
                ratioInput.style.background = 'rgba(16, 185, 129, 0.1)';
                ratioStatus.textContent = `‚úì Ratio ${CEDEAR_RATIOS[ticker]}:1 detectado`;
                ratioStatus.style.color = '#10b981';
                ratioHelp.textContent = 'Ratio encontrado en base de datos.';
                ratioHelp.style.color = '#10b981';
                return;
            }
            
            // Not found - enable manual input
            ratioInput.value = 1;
            ratioInput.style.background = 'rgba(251, 191, 36, 0.1)';
            ratioStatus.textContent = '‚ö† No encontrado';
            ratioStatus.style.color = '#f59e0b';
            ratioHelp.innerHTML = '<strong style="color: #f59e0b;">Ingresa el ratio manualmente.</strong> Se guardar√° para futuros usos.';
            ratioHelp.style.color = '#f59e0b';
        }

        // Transaction form handler
        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // CCL de la operaci√≥n (editable). Si est√° vac√≠o/invalid, usamos el CCL actual como fallback.
            const cclInputEl = document.getElementById('transactionCCL');
            let cclAtTransaction = parseFloat(cclInputEl?.value);
            if (!cclAtTransaction || cclAtTransaction <= 0) {
                cclAtTransaction = await getCCLRate();
                if (cclInputEl) cclInputEl.value = cclAtTransaction;
            }
            
            const ticker = document.getElementById('ticker').value.toUpperCase();
            const ratio = parseFloat(document.getElementById('ratio').value) || 1;
            
            const transaction = {
                id: Date.now(),
                type: document.getElementById('transactionType').value,
                ticker: ticker,
                quantity: parseFloat(document.getElementById('quantity').value),
                price: parseFloat(document.getElementById('price').value),
                ratio: ratio,
                cclRate: cclAtTransaction, // CCL registrado para esta operaci√≥n
                date: document.getElementById('transactionDate').value,
                timestamp: new Date().toISOString()
            };

            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            // Save custom ratio if ticker not in database
            if (!CEDEAR_RATIOS[ticker] && ratio > 1) {
                customRatios[ticker] = ratio;
                localStorage.setItem('customRatios', JSON.stringify(customRatios));
                console.log(`üíæ Custom ratio saved: ${ticker} = ${ratio}:1`);
            }
            
            closeTransactionModal();
            updatePortfolio();
            updateTransactionsList();
            updateVentas();
            
            console.log(`üíæ Transaction saved with CCL rate: $${cclAtTransaction}`);
            
            // Reset form
            document.getElementById('transactionForm').reset();
            const cclElReset = document.getElementById('transactionCCL');
            if (cclElReset) cclElReset.dataset.userEdited = 'false';
            document.getElementById('transactionDate').valueAsDate = new Date();
            autoDetectRatio(); // Reset ratio field
        });

        function openTransactionModal() {
            document.getElementById('transactionModal').classList.add('active');
            // Sugerir CCL para la fecha seleccionada (modo B: no pisar si el usuario edita)
            const dateEl = document.getElementById('transactionDate');
            const cclEl = document.getElementById('transactionCCL');
            if (cclEl) cclEl.dataset.userEdited = 'false';
            if (dateEl && dateEl.value) {
                suggestCCLForDate(dateEl.value);
            } else if (dateEl) {
                // set hoy por defecto si est√° vac√≠o
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth()+1).padStart(2,'0');
                const d = String(today.getDate()).padStart(2,'0');
                dateEl.value = `${y}-${m}-${d}`;
                suggestCCLForDate(dateEl.value);
            }
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all tabs
            document.getElementById('resumenTab').style.display = 'none';
            document.getElementById('historialTab').style.display = 'none';
            document.getElementById('graficosTab').style.display = 'none';
            document.getElementById('rendimientosTab').style.display = 'none';
            document.getElementById('heatmapTab').style.display = 'none';
            document.getElementById('ventasTab').style.display = 'none';
            document.getElementById('benchmarksTab').style.display = 'none';
            document.getElementById('objetivosTab').style.display = 'none';

            // Show selected tab
            if (tabName === 'resumen') {
                document.getElementById('resumenTab').style.display = 'block';
            } else if (tabName === 'historial') {
                document.getElementById('historialTab').style.display = 'block';
            } else if (tabName === 'graficos') {
                document.getElementById('graficosTab').style.display = 'block';
                // Generate charts when tab is shown
                setTimeout(() => generateCharts(), 100);
            } else if (tabName === 'rendimientos') {
                document.getElementById('rendimientosTab').style.display = 'block';
                // Generate rendimientos charts when tab is shown
                setTimeout(() => generateRendimientosCharts(), 100);
            } else if (tabName === 'heatmap') {
                document.getElementById('heatmapTab').style.display = 'block';
                // Generate heatmap when tab is shown
                setTimeout(() => refreshHeatmap(), 100);
            } else if (tabName === 'ventas') {
                document.getElementById('ventasTab').style.display = 'block';
            } else if (tabName === 'benchmarks') {
                document.getElementById('benchmarksTab').style.display = 'block';
                // Generate benchmark comparison when tab is shown
                setTimeout(() => initBenchmarks(), 100);
            } else if (tabName === 'objetivos') {
                document.getElementById('objetivosTab').style.display = 'block';
                // Update objetivos when tab is shown
                setTimeout(() => actualizarObjetivos(), 100);
            }
        }

        async function updatePortfolio() {
            const portfolio = calculatePortfolio();
            const tbody = document.getElementById('portfolioBody');
            tbody.innerHTML = '';

            // Get CCL rate
            const cclRate = await getCCLRate();
            console.log(`üíµ CCL Rate: $${cclRate}`);
            document.getElementById('cclRate').textContent = `$${cclRate.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            let totalValueARS = 0;
            let totalInvestedARS = 0;
            let totalValueUSD = 0;
            let totalInvestedUSD = 0;

            for (const [ticker, data] of Object.entries(portfolio)) {
                if (data.quantity > 0) {
                    console.log(`\nüìä Processing ${ticker}...`);
                    
                    const currentPriceUSD = await getCEDEARPriceUSD(ticker, data.ratio);
                    const currentPrice = currentPriceUSD * cclRate;
                    
                    if (currentPrice === 0 || currentPriceUSD === 0) {
                        console.error(`‚ùå Failed to get prices for ${ticker}`);
                        // Still show the row but with warning
                    }
                    
                    const valueARS = currentPrice * data.quantity;
                    const investedARS = data.averagePrice * data.quantity;
                    const returnARS = investedARS > 0 ? ((currentPrice - data.averagePrice) / data.averagePrice) * 100 : 0;
                    
                    // ‚úÖ F√ìRMULA CORRECTA AMEBA:
                    // RendimientoUSD = cantidad √ó ((PrecioActualARS / CCLActual) - (PrecioCompraARS / CCLCompra))
                    
                    // CCL de compra (impl√≠cito)
                    const cclCompra = data.averagePriceUSD > 0 ? data.averagePrice / data.averagePriceUSD : cclRate;
                    
                    // Precio unitario actual en USD (usando CCL actual)
                    const precioActualUnitarioUSD = currentPrice / cclRate;
                    
                    // Precio unitario compra en USD (usando CCL de compra)
                    const precioCompraUnitarioUSD = data.averagePrice / cclCompra;
                    
                    // Rendimiento total en USD seg√∫n f√≥rmula Ameba
                    const rendimientoTotalUSD = data.quantity * (precioActualUnitarioUSD - precioCompraUnitarioUSD);
                    
                    // Valores totales para la tabla
                    const valueUSD = precioActualUnitarioUSD * data.quantity;
                    const investedUSD = precioCompraUnitarioUSD * data.quantity;
                    const returnUSD = investedUSD > 0 ? (rendimientoTotalUSD / investedUSD) * 100 : 0;

                    console.log(`  üí∞ Cost basis: $${data.averagePrice.toFixed(2)} ARS / $${data.averagePriceUSD.toFixed(2)} USD (historical CCL)`);
                    console.log(`  üìà Return: ${returnARS.toFixed(2)}% ARS / ${returnUSD.toFixed(2)}% USD`);

                    totalValueARS += valueARS;
                    totalInvestedARS += investedARS;
                    totalValueUSD += valueUSD;
                    totalInvestedUSD += investedUSD;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="ticker-cell">
                                <div class="ticker-logo">${ticker.substring(0, 2)}</div>
                                <strong>${ticker}</strong>
                                ${data.ratio > 1 ? `<span style="font-size: 11px; color: #6b7280; margin-left: 5px;">(${data.ratio}:1)</span>` : ''}
                            </div>
                        </td>
                        <td>${data.quantity}</td>
                        <td>$${data.averagePrice.toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                        <td>${currentPrice > 0 ? '$' + currentPrice.toLocaleString('es-AR', {minimumFractionDigits: 2}) : '<span style="color: #f59e0b;">Cargando...</span>'}</td>
                        <td>${currentPriceUSD > 0 ? '$' + currentPriceUSD.toLocaleString('en-US', {minimumFractionDigits: 2}) + ' USD' : '<span style="color: #f59e0b;">Cargando...</span>'}</td>
                        <td style="font-weight: 600; color: #3b82f6;">${currentPriceUSD > 0 ? '$' + valueUSD.toLocaleString('en-US', {minimumFractionDigits: 2}) + ' USD' : '-'}</td>
                        <td class="${returnARS >= 0 ? 'positive' : 'negative'}">
                            ${currentPrice > 0 ? '$' + (valueARS - investedARS).toLocaleString('es-AR', {minimumFractionDigits: 2}) + '<br>(' + (returnARS >= 0 ? '+' : '') + returnARS.toFixed(2) + '%)' : '-'}
                        </td>
                        <td class="${returnUSD >= 0 ? 'positive' : 'negative'}">
                            ${currentPrice > 0 ? '$' + rendimientoTotalUSD.toLocaleString('en-US', {minimumFractionDigits: 2}) + '<br>(' + (returnUSD >= 0 ? '+' : '') + returnUSD.toFixed(2) + '%)' : '-'}
                        </td>
                        <td>
                            <div class="actions-cell">
                                <button class="btn btn-secondary btn-small" onclick="viewHistory('${ticker}')" style="margin-right: 5px;">üìä Historial</button>
                                <button class="btn btn-danger btn-small" onclick="deleteTicker('${ticker}')" style="background: #ef4444; border: 1px solid #dc2626;">üóëÔ∏è Borrar</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            }

            // Update summary cards with detailed breakdown
            const totalReturnARS = totalInvestedARS > 0 ? ((totalValueARS - totalInvestedARS) / totalInvestedARS) * 100 : 0;
            const totalReturnUSD = totalInvestedUSD > 0 ? ((totalValueUSD - totalInvestedUSD) / totalInvestedUSD) * 100 : 0;
            const returnAbsoluteARS = totalValueARS - totalInvestedARS;
            const returnAbsoluteUSD = totalValueUSD - totalInvestedUSD;
            const instrumentCount = Object.keys(portfolio).filter(ticker => portfolio[ticker].quantity > 0).length;

            // Total Invertido
            document.getElementById('totalInvestedARS').textContent = `$${totalInvestedARS.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
            document.getElementById('totalInvestedUSD').textContent = `$${totalInvestedUSD.toLocaleString('en-US', {minimumFractionDigits: 2})}`;

            // Valor Actual
            document.getElementById('totalValueARS').textContent = `$${totalValueARS.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
            document.getElementById('totalValueUSD').textContent = `$${totalValueUSD.toLocaleString('en-US', {minimumFractionDigits: 2})}`;

            // Rendimiento No Realizado
            document.getElementById('returnAbsoluteARS').textContent = `$${returnAbsoluteARS.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
            document.getElementById('returnAbsoluteARS').className = returnAbsoluteARS >= 0 ? 'positive' : 'negative';
            
            document.getElementById('returnPercentARS').textContent = `${totalReturnARS >= 0 ? '+' : ''}${totalReturnARS.toFixed(2)}%`;
            document.getElementById('returnPercentARS').className = totalReturnARS >= 0 ? 'positive' : 'negative';

            document.getElementById('returnAbsoluteUSD').textContent = `$${returnAbsoluteUSD.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('returnAbsoluteUSD').className = returnAbsoluteUSD >= 0 ? 'positive' : 'negative';
            
            document.getElementById('returnPercentUSD').textContent = `${totalReturnUSD >= 0 ? '+' : ''}${totalReturnUSD.toFixed(2)}%`;
            document.getElementById('returnPercentUSD').className = totalReturnUSD >= 0 ? 'positive' : 'negative';

            // Total Instrumentos
            document.getElementById('totalInstruments').textContent = instrumentCount;
            
            console.log(`\n‚úÖ Portfolio update complete!`);
        }

        function calculatePortfolio() {
            const portfolio = {};

            transactions.forEach(tx => {
                if (!portfolio[tx.ticker]) {
                    // ALWAYS use ratio from CEDEAR_RATIOS dictionary (updated)
                    // NOT from stored transaction (may be outdated)
                    const currentRatio = CEDEAR_RATIOS[tx.ticker] || 1;
                    
                    portfolio[tx.ticker] = {
                        quantity: 0,
                        totalInvested: 0,
                        totalInvestedUSD: 0, // Track USD invested using historical CCL
                        averagePrice: 0,
                        averagePriceUSD: 0,
                        ratio: currentRatio  // ‚úÖ Use updated ratio from dictionary
                    };
                }

                // NO update ratio from transaction - always use dictionary value
                // (Old transactions may have outdated ratios from v18)

                if (tx.type === 'buy') {
                    const investmentARS = tx.quantity * tx.price;
                    portfolio[tx.ticker].totalInvested += investmentARS;
                    portfolio[tx.ticker].quantity += tx.quantity;
                    
                    // Calculate USD investment using CCL at time of purchase
                    const cclAtPurchase = tx.cclRate || 1500; // Use saved CCL or default
                    const investmentUSD = investmentARS / cclAtPurchase;
                    portfolio[tx.ticker].totalInvestedUSD += investmentUSD;
                    
                } else if (tx.type === 'sell') {
                    const sellValue = tx.quantity * portfolio[tx.ticker].averagePrice;
                    portfolio[tx.ticker].totalInvested -= sellValue;
                    portfolio[tx.ticker].quantity -= tx.quantity;
                    
                    // Also reduce USD investment proportionally
                    const sellProportion = tx.quantity / (portfolio[tx.ticker].quantity + tx.quantity);
                    portfolio[tx.ticker].totalInvestedUSD *= (1 - sellProportion);
                }

                if (portfolio[tx.ticker].quantity > 0) {
                    portfolio[tx.ticker].averagePrice = portfolio[tx.ticker].totalInvested / portfolio[tx.ticker].quantity;
                    portfolio[tx.ticker].averagePriceUSD = portfolio[tx.ticker].totalInvestedUSD / portfolio[tx.ticker].quantity;
                } else {
                    portfolio[tx.ticker].averagePrice = 0;
                    portfolio[tx.ticker].averagePriceUSD = 0;
                    portfolio[tx.ticker].totalInvested = 0;
                    portfolio[tx.ticker].totalInvestedUSD = 0;
                }
            });

            return portfolio;
        }

        async function getUSStockPrice(ticker) {
            console.log(`Fetching US price for ${ticker}...`);
            
            // ‚úÖ USANDO BACKEND PROPIO EN VERCEL (sin problemas de CORS)
            const backendUrl = 'https://portfolio-backend-psi-teal.vercel.app/api/yahoo';
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`;
            
            try {
                const url = `${backendUrl}?url=${encodeURIComponent(yahooUrl)}`;
                console.log(`  ‚Üí Using Vercel backend...`);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const price = data.chart.result[0].meta.regularMarketPrice;
                    console.log(`‚úì ${ticker} US price: $${price} (via Vercel backend)`);
                    return price || 0;
                }
            } catch (error) {
                console.error(`‚ùå Backend failed for ${ticker}:`, error.message);
            }
            
            return 0;
        }

        async function getCEDEARPriceUSD(ticker, ratio) {
            // Get the US stock price and divide by ratio
            const usPrice = await getUSStockPrice(ticker);
            if (usPrice > 0) {
                const cedearPrice = usPrice / ratio;
                console.log(`‚úì ${ticker} CEDEAR USD: $${cedearPrice.toFixed(2)} (US: $${usPrice} / Ratio: ${ratio})`);
                return cedearPrice;
            }
            console.warn(`‚ö† Could not calculate CEDEAR price for ${ticker}`);
            return 0;
        }

        async function getCurrentPrice(ticker, ratio, cclRate) {
            // Calculate CEDEAR price in ARS using formula:
            // Precio CEDEAR ARS = (Precio acci√≥n USA / Ratio) √ó CCL
            const usPriceUSD = await getCEDEARPriceUSD(ticker, ratio);
            if (usPriceUSD > 0 && cclRate > 0) {
                const priceARS = usPriceUSD * cclRate;
                console.log(`‚úì ${ticker} CEDEAR ARS: $${priceARS.toFixed(2)} (USD: $${usPriceUSD.toFixed(2)} √ó CCL: $${cclRate})`);
                return priceARS;
            }
            console.warn(`‚ö† Could not calculate ARS price for ${ticker}`);
            return 0;
        }

        async function getCCLRate() {
            try {
                console.log('Fetching CCL rate...');
                const response = await fetch('https://dolarapi.com/v1/dolares/contadoconliqui');
                const data = await response.json();
                const rate = data.venta || 1500;
                console.log(`‚úì CCL Rate: $${rate}`);
                return rate;
            } catch (error) {
                console.error('‚ùå Error fetching CCL rate:', error);
                console.warn('‚ö† Using default CCL rate: $1500');
                return 1500; // Default value
            }
        }


        // === CCL hist√≥rico (Sugerencia por fecha) ===
        // Modo B: sugerir autom√°ticamente seg√∫n fecha, pero siempre editable.
        let cclHistoryCache = {};
        try {
            cclHistoryCache = JSON.parse(localStorage.getItem('cclHistoryCache') || '{}');
        } catch (e) {
            cclHistoryCache = {};
        }

        function formatDateForArgentinaDatos(dateStr) {
            // dateStr: YYYY-MM-DD
            if (!dateStr || typeof dateStr !== 'string') return null;
            const parts = dateStr.split('-');
            if (parts.length !== 3) return null;
            return `${parts[0]}/${parts[1]}/${parts[2]}`;
        }

        async function getCCLRateForDate(dateStr) {
            // Devuelve number o null
            if (!dateStr) return null;
            if (cclHistoryCache[dateStr]) return cclHistoryCache[dateStr];

            const apiDate = formatDateForArgentinaDatos(dateStr);
            if (!apiDate) return null;

            try {
                // ArgentinaDatos: CCL por fecha
                const url = `https://api.argentinadatos.com/v1/cotizaciones/dolares/contadoconliqui/${apiDate}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                // Algunas respuestas pueden venir como {venta:..., compra:...} o {value:...}
                const rate = (data && (data.venta ?? data.valor ?? data.value ?? data.ccl)) ? Number(data.venta ?? data.valor ?? data.value ?? data.ccl) : null;
                if (rate && rate > 0) {
                    cclHistoryCache[dateStr] = rate;
                    localStorage.setItem('cclHistoryCache', JSON.stringify(cclHistoryCache));
                    return rate;
                }
                return null;
            } catch (err) {
                console.warn('‚ö† No se pudo obtener CCL hist√≥rico para', dateStr, err);
                return null;
            }
        }

        async function suggestCCLForDate(dateStr) {
            const cclInput = document.getElementById('transactionCCL');
            const suggestEl = document.getElementById('cclSuggest');
            if (!cclInput || !suggestEl) return;

            // Si el usuario ya edit√≥ manualmente, no pisar su valor
            const userEdited = cclInput.dataset.userEdited === 'true';

            // Intentar buscar CCL de esa fecha; si no hay, retroceder hasta 7 d√≠as
            let rate = await getCCLRateForDate(dateStr);
            if (!rate) {
                try {
                    const base = new Date(dateStr + 'T00:00:00');
                    for (let i = 1; i <= 7 && !rate; i++) {
                        const d = new Date(base);
                        d.setDate(d.getDate() - i);
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const backStr = `${y}-${m}-${day}`;
                        rate = await getCCLRateForDate(backStr);
                    }
                } catch (e) {}
            }

            if (rate) {
                suggestEl.textContent = `(sugerido: ${rate.toLocaleString('es-AR', {maximumFractionDigits: 2})})`;
                if (!userEdited && (!cclInput.value || Number(cclInput.value) <= 0)) {
                    cclInput.value = rate;
                }
            } else {
                suggestEl.textContent = '(sin dato hist√≥rico - editable)';
                if (!userEdited && (!cclInput.value || Number(cclInput.value) <= 0)) {
                    // fallback al CCL actual solo como sugerencia base
                    const live = await getCCLRate();
                    cclInput.value = live;
                    suggestEl.textContent = `(sugerido: ${live.toLocaleString('es-AR', {maximumFractionDigits: 2})})`;
                }
            }
        }

        // Listeners para sugerencia de CCL en el formulario
        document.addEventListener('DOMContentLoaded', () => {
            const dateEl = document.getElementById('transactionDate');
            const cclEl = document.getElementById('transactionCCL');

            if (cclEl) {
                cclEl.addEventListener('input', () => {
                    cclEl.dataset.userEdited = 'true';
                });
            }

            if (dateEl) {
                dateEl.addEventListener('change', async () => {
                    // Si el usuario no toc√≥ el CCL, sugerimos por fecha
                    await suggestCCLForDate(dateEl.value);
                });
            }
        });


        function updateTransactionsList() {
            const list = document.getElementById('transactionsList');
            
            // Sort by date (most recent first)
            const sortedTransactions = [...transactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            if (sortedTransactions.length === 0) {
                list.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 40px;">No hay transacciones registradas</p>';
                return;
            }

            // Generate color for ticker logo
            function getTickerColor(ticker) {
                const colors = [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
                    '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
                ];
                let hash = 0;
                for (let i = 0; i < ticker.length; i++) {
                    hash = ticker.charCodeAt(i) + ((hash << 5) - hash);
                }
                return colors[Math.abs(hash) % colors.length];
            }

            // Create table
            let tableHTML = `
                <div class="historial-table-container">
                    <table class="historial-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Fecha</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Tipo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sortedTransactions.forEach((tx, index) => {
                const priceUSD = tx.cclRate ? (tx.price / tx.cclRate).toFixed(2) : 'N/A';
                const ratio = tx.ratio && tx.ratio > 1 ? ` (${tx.ratio}:1)` : '';
                const color = getTickerColor(tx.ticker);
                
                tableHTML += `
                    <tr>
                        <td>
                            <div class="ticker-cell">
                                <div class="ticker-logo" style="background: ${color}">
                                    ${tx.ticker.substring(0, 3)}
                                </div>
                                <div class="ticker-info">
                                    <div class="ticker-name">${tx.ticker}</div>
                                    ${ratio ? `<div class="ticker-ratio">Ratio: ${ratio}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>${new Date(tx.date).toLocaleDateString('es-AR')}</td>
                        <td>${tx.quantity}</td>
                        <td>
                            <div class="precio-cell">
                                <div class="precio-ars">$${tx.price.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                <div class="precio-usd">${priceUSD !== 'N/A' ? '$' + parseFloat(priceUSD).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' USD' : 'N/A'}</div>
                            </div>
                        </td>
                        <td>
                            <span class="tipo-badge ${tx.type === 'buy' ? 'compra' : 'venta'}">
                                ${tx.type === 'buy' ? 'Compra' : 'Venta'}
                            </span>
                        </td>
                        <td>
                            <div class="historial-actions">
                                <button class="btn-edit" onclick="editTransaction(${index})" title="Editar">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn-delete" onclick="deleteTransaction(${index})" title="Eliminar">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            list.innerHTML = tableHTML;
        }

        function editTransaction(index) {
            const sortedTransactions = [...transactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            const tx = sortedTransactions[index];
            const originalIndex = transactions.findIndex(t => 
                t.ticker === tx.ticker && 
                t.date === tx.date && 
                t.quantity === tx.quantity &&
                t.price === tx.price
            );
            
            alert('Funci√≥n de editar en desarrollo. Por ahora puedes eliminar y crear una nueva transacci√≥n.\n\n' +
                  'Datos:\n' +
                  'Ticker: ' + tx.ticker + '\n' +
                  'Tipo: ' + (tx.type === 'buy' ? 'Compra' : 'Venta') + '\n' +
                  'Cantidad: ' + tx.quantity + '\n' +
                  'Precio: $' + tx.price.toLocaleString('es-AR'));
        }

        function deleteTransaction(index) {
            const sortedTransactions = [...transactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            const tx = sortedTransactions[index];
            
            const confirmDelete = confirm(
                '¬øEst√°s seguro que deseas eliminar esta transacci√≥n?\n\n' +
                'Ticker: ' + tx.ticker + '\n' +
                'Tipo: ' + (tx.type === 'buy' ? 'Compra' : 'Venta') + '\n' +
                'Cantidad: ' + tx.quantity + '\n' +
                'Precio: $' + tx.price.toLocaleString('es-AR') + '\n' +
                'Fecha: ' + new Date(tx.date).toLocaleDateString('es-AR') + '\n\n' +
                'Esta acci√≥n NO se puede deshacer.'
            );
            
            if (confirmDelete) {
                // Find original index in unsorted array
                const originalIndex = transactions.findIndex(t => 
                    t.ticker === tx.ticker && 
                    t.date === tx.date && 
                    t.quantity === tx.quantity &&
                    t.price === tx.price &&
                    t.type === tx.type
                );
                
                if (originalIndex !== -1) {
                    transactions.splice(originalIndex, 1);
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    updatePortfolio();
                    updateTransactionsList();
                    updateVentas();
                    alert('Transacci√≥n eliminada exitosamente');
                }
            }
        }

        function updateVentas() {
            const ventasContent = document.getElementById('ventasContent');
            
            // Helper function to generate color for ticker
            function getTickerColor(ticker) {
                const colors = [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
                    '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
                ];
                let hash = 0;
                for (let i = 0; i < ticker.length; i++) {
                    hash = ticker.charCodeAt(i) + ((hash << 5) - hash);
                }
                return colors[Math.abs(hash) % colors.length];
            }

            // Get all tickers with sales
            const tickersWithSales = {};
            
            transactions.forEach(tx => {
                if (tx.type === 'sell') {
                    if (!tickersWithSales[tx.ticker]) {
                        tickersWithSales[tx.ticker] = [];
                    }
                    tickersWithSales[tx.ticker].push(tx);
                }
            });

            // If no sales, show message
            if (Object.keys(tickersWithSales).length === 0) {
                ventasContent.innerHTML = `
                    <div class="no-ventas">
                        <div class="no-ventas-icon">üíµ</div>
                        <div class="no-ventas-title">No hay ventas registradas</div>
                        <div class="no-ventas-text">Las ventas que realices aparecer√°n aqu√≠</div>
                    </div>
                `;
                return;
            }

            // Generate sales content for each ticker
            let html = '';

            for (const ticker in tickersWithSales) {
                const sales = tickersWithSales[ticker];
                const color = getTickerColor(ticker);
                
                // Get all transactions for this ticker (buys and sells)
                const tickerTxs = transactions.filter(tx => tx.ticker === ticker);
                tickerTxs.sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort by date (FIFO)
                
                // Calculate totals
                let totalQuantitySold = 0;
                let totalGananciaARS = 0;
                let totalGananciaUSD = 0;
                
                const salesDetails = [];
                
                sales.forEach(sale => {
                    totalQuantitySold += sale.quantity;
                    
                    // Calculate average buy price using FIFO
                    let remainingToMatch = sale.quantity;
                    let totalCostARS = 0;
                    let totalCostUSD = 0;
                    
                    for (const tx of tickerTxs) {
                        if (tx.type === 'buy' && new Date(tx.date) <= new Date(sale.date) && remainingToMatch > 0) {
                            const qtyToUse = Math.min(remainingToMatch, tx.quantity);
                            totalCostARS += qtyToUse * tx.price;
                            totalCostUSD += qtyToUse * (tx.cclRate ? tx.price / tx.cclRate : 0);
                            remainingToMatch -= qtyToUse;
                        }
                        if (remainingToMatch <= 0) break;
                    }
                    
                    const avgBuyPriceARS = totalCostARS / sale.quantity;
                    const avgBuyPriceUSD = totalCostUSD / sale.quantity;
                    
                    const saleValueARS = sale.quantity * sale.price;
                    const saleValueUSD = sale.cclRate ? saleValueARS / sale.cclRate : 0;
                    
                    const gananciaARS = saleValueARS - totalCostARS;
                    const gananciaUSD = saleValueUSD - totalCostUSD;
                    
                    const gananciaPercARS = (gananciaARS / totalCostARS) * 100;
                    const gananciaPercUSD = (gananciaUSD / totalCostUSD) * 100;
                    
                    totalGananciaARS += gananciaARS;
                    totalGananciaUSD += gananciaUSD;
                    
                    salesDetails.push({
                        date: sale.date,
                        quantity: sale.quantity,
                        buyPriceARS: avgBuyPriceARS,
                        sellPriceARS: sale.price,
                        gananciaARS: gananciaARS,
                        gananciaPercARS: gananciaPercARS,
                        gananciaUSD: gananciaUSD,
                        gananciaPercUSD: gananciaPercUSD
                    });
                });
                
                // Sort sales by date (most recent first)
                salesDetails.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Generate HTML for this ticker
                html += `
                    <div class="ventas-ticker-section">
                        <div class="ventas-ticker-header">
                            <div class="ventas-ticker-logo" style="background: ${color}">
                                ${ticker.substring(0, 3)}
                            </div>
                            <div class="ventas-ticker-name">${ticker}</div>
                        </div>
                        
                        <div class="ventas-summary-cards">
                            <div class="ventas-summary-card">
                                <h4>Cantidad:</h4>
                                <div class="value">${totalQuantitySold}</div>
                            </div>
                            <div class="ventas-summary-card">
                                <h4>Ganancia ARS:</h4>
                                <div class="value positive">$ ${totalGananciaARS.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div class="ventas-summary-card">
                                <h4>Ganancia USD:</h4>
                                <div class="value positive">$${totalGananciaUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        
                        <table class="ventas-table">
                            <thead>
                                <tr>
                                    <th>FECHA VENTA</th>
                                    <th>CANTIDAD</th>
                                    <th>PRECIO COMPRA</th>
                                    <th>PRECIO VENTA</th>
                                    <th>GANANCIA ARS</th>
                                    <th>GANANCIA USD</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                salesDetails.forEach(detail => {
                    html += `
                        <tr>
                            <td>${new Date(detail.date).toLocaleDateString('es-AR')}</td>
                            <td>${detail.quantity}</td>
                            <td>$ ${detail.buyPriceARS.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td>$ ${detail.sellPriceARS.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td>
                                <div class="ganancia-cell">
                                    <div class="ganancia-valor">$ ${detail.gananciaARS.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div class="ganancia-porcentaje">(${detail.gananciaPercARS.toFixed(2)}%)</div>
                                </div>
                            </td>
                            <td>
                                <div class="ganancia-cell" style="align-items: flex-end;">
                                    <div class="ganancia-valor">$${detail.gananciaUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    <div class="ganancia-porcentaje">(${detail.gananciaPercUSD.toFixed(2)}%)</div>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            ventasContent.innerHTML = html;
        }

        function viewHistory(ticker) {
            const tickerTransactions = transactions.filter(tx => tx.ticker === ticker);
            const ratio = tickerTransactions[0]?.ratio || 1;
            alert(`Historial de ${ticker}${ratio > 1 ? ` (Ratio ${ratio}:1)` : ''}:\n\n` + 
                tickerTransactions.map(tx => 
                    `${tx.type === 'buy' ? 'COMPRA' : 'VENTA'}: ${tx.quantity} a $${tx.price}${tx.cclRate ? ` (CCL: $${tx.cclRate.toFixed(2)})` : ''} (${new Date(tx.date).toLocaleDateString('es-AR')})`
                ).join('\n')
            );
        }

        function deleteTicker(ticker) {
            const tickerTransactions = transactions.filter(tx => tx.ticker === ticker);
            const ratio = tickerTransactions[0]?.ratio || 1;
            const totalQuantity = tickerTransactions.reduce((sum, tx) => {
                return tx.type === 'buy' ? sum + tx.quantity : sum - tx.quantity;
            }, 0);
            
            const confirmDelete = confirm(
                `‚ö†Ô∏è ¬øEst√°s seguro que deseas eliminar ${ticker}${ratio > 1 ? ` (Ratio ${ratio}:1)` : ''}?\n\n` +
                `Se eliminar√°n ${tickerTransactions.length} transacci√≥n(es)\n` +
                `Cantidad total: ${totalQuantity}\n\n` +
                `Esta acci√≥n NO se puede deshacer.`
            );
            
            if (confirmDelete) {
                // Remove all transactions for this ticker
                transactions = transactions.filter(tx => tx.ticker !== ticker);
                
                // Save to localStorage
                localStorage.setItem('transactions', JSON.stringify(transactions));
                
                console.log(`üóëÔ∏è Ticker ${ticker} eliminado (${tickerTransactions.length} transacciones)`);
                
                // Update display
                updatePortfolio();
                displayTransactions();
                
                alert(`‚úÖ ${ticker} eliminado exitosamente`);
            }
        }

        // ============================================
        // CHART FUNCTIONS
        // ============================================

        function generateCharts() {
            const portfolio = calculatePortfolio();
            
            // Get current prices and values
            let portfolioData = [];
            let totalValue = 0;
            
            Object.keys(portfolio).forEach(ticker => {
                if (portfolio[ticker].quantity > 0) {
                    // We'll use the value from the DOM if available, otherwise estimate
                    const valueUSD = portfolio[ticker].quantity * portfolio[ticker].averagePriceUSD;
                    portfolioData.push({
                        ticker: ticker,
                        value: valueUSD,
                        quantity: portfolio[ticker].quantity,
                        ratio: portfolio[ticker].ratio,
                        sector: TICKER_SECTORS[ticker] || 'Otros'
                    });
                    totalValue += valueUSD;
                }
            });

            // Generate each chart
            generatePortfolioChart(portfolioData, totalValue);
            generateMarketChart(portfolioData);
            generateSectorChart(portfolioData);
            generateValueChart(portfolioData, 'ARS');
        }

        function generatePortfolioChart(portfolioData, totalValue) {
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;

            // Destroy existing chart
            if (chartInstances.portfolio) {
                chartInstances.portfolio.destroy();
            }

            // Sort by value and limit to top items
            const sortedData = portfolioData.sort((a, b) => b.value - a.value);
            
            const labels = sortedData.map(item => item.ticker);
            const data = sortedData.map(item => ((item.value / totalValue) * 100).toFixed(2));
            
            // Generate colors
            const colors = generateColors(sortedData.length);

            chartInstances.portfolio = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#1f2937',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                font: { 
                                    size: 11,
                                    family: 'Arial, sans-serif'
                                },
                                padding: 10,
                                boxWidth: 15,
                                boxHeight: 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} (${data.datasets[0].data[i]}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i,
                                        fontColor: '#ffffff'
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed}%`;
                                }
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    }
                }
            });
        }

        function generateMarketChart(portfolioData) {
            const ctx = document.getElementById('marketChart');
            if (!ctx) return;

            if (chartInstances.market) {
                chartInstances.market.destroy();
            }

            // Classify as CEDEAR vs ETF
            const marketData = { 'CEDEAR': 0, 'ETF': 0 };
            portfolioData.forEach(item => {
                if (item.sector === 'ETF') {
                    marketData['ETF'] += item.value;
                } else {
                    marketData['CEDEAR'] += item.value;
                }
            });

            const total = Object.values(marketData).reduce((a, b) => a + b, 0);
            const labels = Object.keys(marketData);
            const data = Object.values(marketData).map(val => ((val / total) * 100).toFixed(2));

            chartInstances.market = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#8b5cf6', '#3b82f6'],
                        borderColor: '#1f2937',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                font: { 
                                    size: 13,
                                    family: 'Arial, sans-serif',
                                    weight: 'bold'
                                },
                                padding: 15,
                                boxWidth: 20,
                                boxHeight: 20,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} (${data.datasets[0].data[i]}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i,
                                        fontColor: '#ffffff'
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 }
                        },
                        datalabels: {
                            display: false
                        }
                    }
                }
            });
        }

        function generateSectorChart(portfolioData) {
            const ctx = document.getElementById('sectorChart');
            if (!ctx) return;

            if (chartInstances.sector) {
                chartInstances.sector.destroy();
            }

            // Group by sector
            const sectorData = {};
            portfolioData.forEach(item => {
                if (!sectorData[item.sector]) {
                    sectorData[item.sector] = 0;
                }
                sectorData[item.sector] += item.value;
            });

            // Calculate percentages and sort
            const total = Object.values(sectorData).reduce((a, b) => a + b, 0);
            const sortedSectors = Object.entries(sectorData)
                .map(([sector, value]) => ({
                    sector,
                    value,
                    percentage: ((value / total) * 100).toFixed(1)
                }))
                .sort((a, b) => b.value - a.value);

            const labels = sortedSectors.map(item => item.sector);
            const data = sortedSectors.map(item => parseFloat(item.percentage));
            const colors = generateColors(sortedSectors.length);

            chartInstances.sector = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#1f2937',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.x}%`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#ffffff',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            anchor: 'end',
                            align: 'end',
                            formatter: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { size: 11 },
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff',
                                font: { size: 11 }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Rendimientos Hist√≥ricos Charts - Generate all rendimientos visualizations
        let rendEvolucionChartInstance = null;
        let rendMensualChartInstance = null;

        async function generateRendimientosCharts() {
            // Get filter values
            const periodoDesde = document.getElementById('rendPeriodoDesde').value;
            const periodoHasta = document.getElementById('rendPeriodoHasta').value;
            const moneda = document.getElementById('rendMoneda').value;
            const usarDatosReales = document.getElementById('rendDatosReales').value === 'true';
            
            // Parse dates
            const fechaDesde = new Date(periodoDesde + '-01');
            const fechaHasta = new Date(periodoHasta + '-01');
            fechaHasta.setMonth(fechaHasta.getMonth() + 1); // End of month
            
            // Calculate monthly data (ASYNC now - puede usar datos hist√≥ricos reales)
            const monthlyData = await calculateMonthlyRendimientos(fechaDesde, fechaHasta, moneda, usarDatosReales);
            
            // Generate evolution chart
            generateEvolucionChart(monthlyData, moneda);
            
            // Generate monthly rendimiento chart
            generateMensualChart(monthlyData);
            
            // Generate table
            generateRendimientosTable(monthlyData, moneda);
        }

        async function calculateMonthlyRendimientos(fechaDesde, fechaHasta, moneda, usarDatosReales = false) {
            const monthlyData = [];
            let currentDate = new Date(fechaDesde);
            
            let totalAportado = 0;
            let valorAnterior = 0;
            let rendimientoAcumulado = 0;
            
            // Obtener CCL actual para conversiones ARS
            const currentCCL = await getCCLRate();
            
            // Mostrar/ocultar alert seg√∫n si usa datos reales
            const alert = document.getElementById('rendimientosAlert');
            const alertText = document.getElementById('rendimientosAlertText');
            
            if (usarDatosReales && alert) {
                alert.style.display = 'block';
                const totalMeses = Math.ceil((fechaHasta - fechaDesde) / (30 * 24 * 60 * 60 * 1000));
                alertText.textContent = `Cargando datos de ${totalMeses} meses... Esto puede tardar unos segundos.`;
            }
            
            let mesIndex = 0;
            const totalMeses = Math.ceil((fechaHasta - fechaDesde) / (30 * 24 * 60 * 60 * 1000));
            
            // ‚úÖ OPCI√ìN 3: Obtener precios actuales UNA VEZ antes del loop
            const priceCache = {};
            const portfolio = calculatePortfolio();
            
            console.log('üìä Obteniendo precios actuales para rendimientos...');
            for (const [ticker, data] of Object.entries(portfolio)) {
                if (data.quantity > 0) {
                    const precioUSD = await getCEDEARPriceUSD(ticker, data.ratio);
                    priceCache[ticker] = precioUSD;
                }
            }
            console.log('‚úÖ Precios obtenidos:', Object.keys(priceCache).length, 'tickers');
            
            while (currentDate <= fechaHasta) {
                const mesKey = currentDate.toISOString().substring(0, 7); // YYYY-MM
                const mesInicio = new Date(currentDate);
                const mesFin = new Date(currentDate);
                mesFin.setMonth(mesFin.getMonth() + 1);
                
                // Actualizar progreso si usa datos reales
                if (usarDatosReales && alert) {
                    mesIndex++;
                    alertText.textContent = `Procesando mes ${mesIndex}/${totalMeses}: ${mesKey}...`;
                }
                
                // Get transactions for this month
                const transaccionesMes = transactions.filter(tx => {
                    const txDate = new Date(tx.date);
                    return txDate >= mesInicio && txDate < mesFin;
                });
                
                // Calculate aportes of the month (only purchases)
                let aportesMes = 0;
                transaccionesMes.forEach(tx => {
                    if (tx.type === 'buy') {
                        const valor = moneda === 'ARS' ? 
                            tx.price * tx.quantity : 
                            (tx.price * tx.quantity) / (tx.cclRate || 1500);
                        aportesMes += valor;
                    }
                });
                
                totalAportado += aportesMes;
                
                // Calculate portfolio value at end of month
                let valorPortfolio = 0;
                
                // ‚úÖ CALCULAR PORTFOLIO PROGRESIVO (solo transacciones hasta este mes)
                const portfolioProgresivo = {};
                const transaccionesHastaAhora = transactions.filter(tx => new Date(tx.date) < mesFin);
                
                transaccionesHastaAhora.forEach(tx => {
                    if (!portfolioProgresivo[tx.ticker]) {
                        portfolioProgresivo[tx.ticker] = {
                            quantity: 0,
                            ratio: CEDEAR_RATIOS[tx.ticker] || 1
                        };
                    }
                    if (tx.type === 'buy') {
                        portfolioProgresivo[tx.ticker].quantity += tx.quantity;
                    } else if (tx.type === 'sell') {
                        portfolioProgresivo[tx.ticker].quantity -= tx.quantity;
                    }
                });
                
                if (usarDatosReales) {
                    // USAR PRECIOS HIST√ìRICOS REALES (Sistema H√≠brido)
                    for (const [ticker, item] of Object.entries(portfolioProgresivo)) {
                        if (item.quantity > 0) {
                            // Obtener precio hist√≥rico del mes
                            const precioData = await obtenerPrecioHistoricoHibrido(ticker, mesKey);
                            const precio = precioData?.price || priceCache[ticker] || 0;
                            const cantidad = item.quantity;
                            
                            if (moneda === 'ARS') {
                                valorPortfolio += (precio * cantidad * (currentCCL || 1500));
                            } else {
                                valorPortfolio += (precio * cantidad);
                            }
                        }
                    }
                } else {
                    // USAR PRECIO ACTUAL (m√©todo r√°pido usando cache)
                    for (const [ticker, item] of Object.entries(portfolioProgresivo)) {
                        if (item.quantity > 0) {
                            const precio = priceCache[ticker] || 0;
                            const cantidad = item.quantity;
                            if (moneda === 'ARS') {
                                valorPortfolio += (precio * cantidad * (currentCCL || 1500));
                            } else {
                                valorPortfolio += (precio * cantidad);
                            }
                        }
                    }
                }
                
                // Calculate P&L no realizado
                const pnlNoRealizado = valorPortfolio - totalAportado;
                
                // Calculate rendimiento mensual
                let rendimientoMes = 0;
                if (valorAnterior > 0) {
                    rendimientoMes = ((valorPortfolio - valorAnterior - aportesMes) / valorAnterior) * 100;
                } else if (totalAportado > 0) {
                    rendimientoMes = ((valorPortfolio - totalAportado) / totalAportado) * 100;
                }
                
                // Calculate rendimiento acumulado
                if (totalAportado > 0) {
                    rendimientoAcumulado = ((valorPortfolio - totalAportado) / totalAportado) * 100;
                }
                
                const netoMes = valorPortfolio - valorAnterior;
                
                monthlyData.push({
                    mes: mesKey,
                    mesLabel: mesInicio.toLocaleDateString('es-AR', { month: 'short', year: 'numeric' }),
                    netoMes: netoMes,
                    valorPortfolio: valorPortfolio,
                    aportesMes: aportesMes,
                    aportesAcumulados: totalAportado,
                    pnlNoRealizado: pnlNoRealizado,
                    rendimientoMes: rendimientoMes,
                    rendimientoAcumulado: rendimientoAcumulado
                });
                
                valorAnterior = valorPortfolio;
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            // Ocultar alert cuando termine
            if (usarDatosReales && alert) {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 1000);
            }
            
            return monthlyData;
        }

        function generateEvolucionChart(monthlyData, moneda) {
            const ctx = document.getElementById('rendEvolucionChart');
            if (!ctx) return;
            
            if (rendEvolucionChartInstance) {
                rendEvolucionChartInstance.destroy();
            }
            
            const labels = monthlyData.map(d => d.mesLabel);
            const valorPortfolio = monthlyData.map(d => d.valorPortfolio);
            const aportesMensuales = monthlyData.map(d => d.aportesMes);
            const aportesAcumulados = monthlyData.map(d => d.aportesAcumulados);
            
            rendEvolucionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Valor Portfolio',
                            data: valorPortfolio,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#8b5cf6'
                        },
                        {
                            label: 'Aportes Mensuales',
                            data: aportesMensuales,
                            borderColor: '#6b7280',
                            backgroundColor: 'rgba(107, 114, 128, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3,
                            pointBackgroundColor: '#6b7280'
                        },
                        {
                            label: 'Aportes Acumulados',
                            data: aportesAcumulados,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3,
                            pointBackgroundColor: '#f59e0b'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                font: { size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    const formatted = moneda === 'ARS' ? 
                                        '$' + value.toLocaleString('es-AR', {minimumFractionDigits: 2}) :
                                        '$' + value.toLocaleString('en-US', {minimumFractionDigits: 2}) + ' USD';
                                    return label + ': ' + formatted;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 11 }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 11 },
                                callback: function(value) {
                                    if (value >= 1000000) return (moneda === 'ARS' ? '$' : '$') + (value/1000000).toFixed(1) + 'M';
                                    if (value >= 1000) return (moneda === 'ARS' ? '$' : '$') + (value/1000).toFixed(0) + 'K';
                                    return (moneda === 'ARS' ? '$' : '$') + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        function generateMensualChart(monthlyData) {
            const ctx = document.getElementById('rendMensualChart');
            if (!ctx) return;
            
            if (rendMensualChartInstance) {
                rendMensualChartInstance.destroy();
            }
            
            const labels = monthlyData.map(d => d.mesLabel);
            const rendimientos = monthlyData.map(d => d.rendimientoMes);
            
            // Colors: green for positive, red for negative
            const backgroundColors = rendimientos.map(r => r >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)');
            const borderColors = rendimientos.map(r => r >= 0 ? '#10b981' : '#ef4444');
            
            rendMensualChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rendimiento Mensual (%)',
                        data: rendimientos,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Rendimiento: ' + context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 11 }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af',
                                font: { size: 11 },
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        function generateRendimientosTable(monthlyData, moneda) {
            const tbody = document.getElementById('rendimientosTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Reverse to show most recent first
            const reversedData = [...monthlyData].reverse();
            
            reversedData.forEach(row => {
                const tr = document.createElement('tr');
                
                const netoClass = row.netoMes >= 0 ? 'positive' : 'negative';
                const rendMesClass = row.rendimientoMes >= 0 ? 'positive' : 'negative';
                const rendAcumClass = row.rendimientoAcumulado >= 0 ? 'positive' : 'negative';
                
                const formatValue = (value) => {
                    if (moneda === 'ARS') {
                        return '$ ' + value.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    } else {
                        return '$ ' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                };
                
                tr.innerHTML = `
                    <td>${row.mes}</td>
                    <td class="${netoClass}">${formatValue(row.netoMes)}</td>
                    <td>${formatValue(row.valorPortfolio)}</td>
                    <td class="${row.pnlNoRealizado >= 0 ? 'positive' : 'negative'}">${formatValue(row.pnlNoRealizado)}</td>
                    <td class="${rendMesClass}">${row.rendimientoMes.toFixed(2)}%</td>
                    <td class="${rendAcumClass}">${row.rendimientoAcumulado.toFixed(2)}%</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', function() {
            const filtros = ['rendPeriodoDesde', 'rendPeriodoHasta', 'rendMoneda', 'rendPortfolio', 'rendFiltros', 'rendDatosReales'];
            filtros.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', () => {
                        if (document.getElementById('rendimientosTab').style.display === 'block') {
                            generateRendimientosCharts();
                        }
                    });
                }
            });
            
            // Actualizar contador de API en init
            updateAPICounter();
        });

        // ===============================================
        // HEATMAP FUNCTIONS - v17
        // ===============================================

        // Utility function for delays
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function refreshHeatmap() {
            console.log('üî• refreshHeatmap() iniciado');
            const container = document.getElementById('heatmapContainer');
            const lastUpdate = document.getElementById('heatmapLastUpdate');
            
            if (!container) {
                console.error('‚ùå heatmapContainer no encontrado');
                return;
            }
            
            // Mostrar loading
            container.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #6b7280;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                    <div style="font-size: 16px;">Cargando datos del mercado...</div>
                    <div style="font-size: 13px; margin-top: 10px; color: #a0a0a0;">Esto puede tardar unos segundos...</div>
                </div>
            `;
            
            try {
                // Obtener portfolio actual
                const portfolio = calculatePortfolio();
                console.log('üìä Portfolio obtenido:', Object.keys(portfolio).length, 'tickers');
                const heatmapData = [];
                
                // Obtener datos de cada activo con variaci√≥n diaria
                let index = 0;
                const totalTickers = Object.entries(portfolio).filter(([_, data]) => data.quantity > 0).length;
                console.log('üìä Tickers activos (quantity > 0):', totalTickers);
                
                for (const [ticker, data] of Object.entries(portfolio)) {
                    if (data.quantity > 0) {
                        index++;
                        
                        // Actualizar progreso
                        container.innerHTML = `
                            <div style="text-align: center; padding: 50px; color: #6b7280;">
                                <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                                <div style="font-size: 16px;">Cargando datos del mercado...</div>
                                <div style="font-size: 13px; margin-top: 10px; color: #a0a0a0;">Procesando ${ticker} (${index}/${totalTickers})</div>
                            </div>
                        `;
                        
                        console.log(`üîÑ Obteniendo datos para ${ticker}...`);
                        
                        // Obtener precio actual USD
                        const currentPriceUSD = await getCEDEARPriceUSD(ticker, data.ratio);
                        
                        // Obtener variaci√≥n diaria
                        const dailyChange = await getDailyChange(ticker);
                        console.log(`‚úÖ ${ticker}: Precio $${currentPriceUSD.toFixed(2)} | Cambio ${dailyChange.toFixed(2)}%`);
                        
                        heatmapData.push({
                            ticker: ticker,
                            quantity: data.quantity,
                            currentPrice: currentPriceUSD,
                            value: currentPriceUSD * data.quantity,
                            dailyChange: dailyChange
                        });
                        
                        // ‚úÖ Delay de 200ms entre cada request para evitar rate limiting
                        if (index < totalTickers) {
                            await sleep(200);
                        }
                    }
                }
                
                // Generar heatmap
                generateHeatmap(heatmapData);
                
                // Actualizar timestamp
                const now = new Date();
                lastUpdate.textContent = `√öltima actualizaci√≥n: ${now.toLocaleTimeString('es-AR')}`;
                
            } catch (error) {
                console.error('Error generando heatmap:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #ef4444;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <div style="font-size: 16px;">Error al cargar el mapa de calor</div>
                        <div style="font-size: 13px; margin-top: 10px; color: #6b7280;">Intenta de nuevo en unos momentos</div>
                    </div>
                `;
            }
        }

        async function getDailyChange(ticker) {
            try {
                // ‚úÖ USANDO BACKEND PROPIO EN VERCEL (sin problemas de CORS)
                const backendUrl = 'https://portfolio-backend-psi-teal.vercel.app/api/yahoo';
                
                // Calcular timestamps - pedir 7 d√≠as para asegurar d√≠as h√°biles
                const now = Math.floor(Date.now() / 1000);
                const sevenDaysAgo = now - (7 * 24 * 60 * 60); // 7 d√≠as completos
                
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?period1=${sevenDaysAgo}&period2=${now}&interval=1d`;
                
                try {
                    const url = `${backendUrl}?url=${encodeURIComponent(yahooUrl)}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    
                    if (data.chart && data.chart.result && data.chart.result[0]) {
                        const quotes = data.chart.result[0].indicators.quote[0];
                        const closes = quotes.close.filter(c => c !== null);
                        
                        if (closes.length >= 2) {
                            // Usar los dos √∫ltimos valores v√°lidos
                            const previousClose = closes[closes.length - 2];
                            const currentClose = closes[closes.length - 1];
                            const change = ((currentClose - previousClose) / previousClose) * 100;
                            
                            console.log(`‚úì ${ticker} daily change: ${change.toFixed(2)}%`);
                            return change;
                        }
                    }
                } catch (e) {
                    console.error(`‚ö†Ô∏è Backend error for ${ticker}:`, e.message);
                }
                
                // Si no se pudo obtener, retornar 0
                console.log(`‚ö†Ô∏è Could not get daily change for ${ticker}, using 0%`);
                return 0;
                
            } catch (error) {
                console.error(`Error getting daily change for ${ticker}:`, error);
                return 0;
            }
        }

        function generateHeatmap(data) {
            const container = document.getElementById('heatmapContainer');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                        <div style="font-size: 16px;">No hay activos en cartera</div>
                    </div>
                `;
                return;
            }
            
            // Ordenar por cambio absoluto (mayor impacto visual primero)
            data.sort((a, b) => Math.abs(b.dailyChange) - Math.abs(a.dailyChange));
            
            // Crear grid
            const grid = document.createElement('div');
            grid.className = 'heatmap-grid';
            
            data.forEach(item => {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                
                // Determinar color basado en cambio
                const colorClass = getColorClass(item.dailyChange);
                cell.classList.add(colorClass);
                
                // Determinar tama√±o basado en magnitud
                const sizeClass = getSizeClass(Math.abs(item.dailyChange));
                cell.classList.add(sizeClass);
                
                // Contenido de la celda
                const changeSign = item.dailyChange >= 0 ? '+' : '';
                cell.innerHTML = `
                    <div class="heatmap-cell-ticker">${item.ticker}</div>
                    <div class="heatmap-cell-change">${changeSign}${item.dailyChange.toFixed(2)}%</div>
                    <div class="heatmap-cell-value">$${item.currentPrice.toFixed(2)}</div>
                `;
                
                // Tooltip en hover
                cell.title = `${item.ticker}
Precio: $${item.currentPrice.toFixed(2)}
Cantidad: ${item.quantity}
Valor: $${item.value.toFixed(2)}
Variaci√≥n diaria: ${changeSign}${item.dailyChange.toFixed(2)}%`;
                
                grid.appendChild(cell);
            });
            
            container.innerHTML = '';
            container.appendChild(grid);
        }

        function getColorClass(change) {
            if (change >= 3) return 'heatmap-positive-strong';
            if (change >= 1) return 'heatmap-positive-moderate';
            if (change >= -1) return 'heatmap-neutral';
            if (change >= -3) return 'heatmap-negative-moderate';
            return 'heatmap-negative-strong';
        }

        function getSizeClass(absChange) {
            if (absChange >= 10) return 'heatmap-size-xl';
            if (absChange >= 7) return 'heatmap-size-lg';
            if (absChange >= 4) return 'heatmap-size-md';
            if (absChange >= 2) return 'heatmap-size-sm';
            return 'heatmap-size-xs';
        }

        // ===============================================
        // EXCEL IMPORT FUNCTIONS - v18
        // ===============================================

        function importFromExcel() {
            document.getElementById('excelFileInput').click();
        }

        async function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Leer primera hoja
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    console.log(`üìä Excel file loaded: ${jsonData.length} rows found`);
                    
                    // Convertir a formato Portfolio Manager
                    const convertedTransactions = await convertExcelToTransactions(jsonData);
                    
                    if (convertedTransactions.length === 0) {
                        alert('‚ùå No se encontraron transacciones v√°lidas en el archivo Excel');
                        return;
                    }
                    
                    // Confirmar con usuario
                    const confirmMessage = `Se encontraron ${convertedTransactions.length} transacciones.
                    
¬øDeseas importarlas?

Opciones:
- OK: Agregar a las transacciones existentes
- Cancelar: No importar`;
                    
                    if (confirm(confirmMessage)) {
                        // Agregar a transacciones existentes
                        transactions.push(...convertedTransactions);
                        
                        // Guardar en localStorage
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        
                        // Actualizar vista
                        updatePortfolio();
                        updateTransactionsList();
                        
                        alert(`‚úÖ ${convertedTransactions.length} transacciones importadas exitosamente!`);
                        
                        console.log(`‚úÖ Imported ${convertedTransactions.length} transactions from Excel`);
                    }
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    alert(`‚ùå Error al leer archivo Excel: ${error.message}
                    
Verifica que el archivo tenga el formato correcto:
- Columnas: Ticker, Broker, Cantidad, Fecha compra, D√≥lar compra, Precio compra`);
                }
            };
            
            reader.readAsArrayBuffer(file);
            
            // Reset input
            event.target.value = '';
        }

        async function convertExcelToTransactions(excelData) {
            const converted = [];
            
            for (const row of excelData) {
                try {
                    // Mapear columnas del Excel
                    const ticker = row['Ticker'] || row['ticker'];
                    const cantidad = parseFloat(row['Cantidad'] || row['cantidad'] || 0);
                    const fechaCompra = row['Fecha compra'] || row['fecha compra'] || row['Fecha'];
                    const dolarCompra = parseFloat(row['D√≥lar compra'] || row['dolar compra'] || row['CCL'] || 1500);
                    const precioCompra = parseFloat(row['Precio compra'] || row['precio compra'] || row['Precio'] || 0);
                    
                    if (!ticker || cantidad <= 0 || precioCompra <= 0) {
                        console.warn(`‚ö†Ô∏è Skipping invalid row:`, row);
                        continue;
                    }
                    
                    // Convertir fecha a formato YYYY-MM-DD
                    let formattedDate;
                    if (typeof fechaCompra === 'number') {
                        // Excel serial date
                        const excelDate = new Date((fechaCompra - 25569) * 86400 * 1000);
                        formattedDate = excelDate.toISOString().split('T')[0];
                    } else if (fechaCompra instanceof Date) {
                        formattedDate = fechaCompra.toISOString().split('T')[0];
                    } else {
                        // String date
                        const parsedDate = new Date(fechaCompra);
                        formattedDate = parsedDate.toISOString().split('T')[0];
                    }
                    
                    // Buscar ratio del CEDEAR en la base de datos
                    const ratio = CEDEAR_RATIOS[ticker] || 1;
                    
                    // Crear transacci√≥n en formato Portfolio Manager
                    const transaction = {
                        id: Date.now() + Math.random(), // ID √∫nico
                        type: 'buy',
                        ticker: ticker.toUpperCase(),
                        quantity: cantidad,
                        price: precioCompra,
                        ratio: ratio,
                        cclRate: dolarCompra,
                        date: formattedDate,
                        timestamp: new Date().toISOString()
                    };
                    
                    converted.push(transaction);
                    
                    console.log(`‚úì Converted: ${ticker} - ${cantidad} @ $${precioCompra} (${formattedDate})`);
                    
                } catch (error) {
                    console.error('Error converting row:', row, error);
                    continue;
                }
            }
            
            return converted;
        }

        async function generateValueChart(portfolioData, currency) {
            const ctx = document.getElementById('valueChart');
            if (!ctx) return;

            if (chartInstances.value) {
                chartInstances.value.destroy();
            }

            const cclRate = await getCCLRate();
            
            // Sort by value
            const sortedData = portfolioData.sort((a, b) => b.value - a.value);
            
            const labels = sortedData.map(item => item.ticker);
            let data, prefix;
            
            if (currency === 'USD') {
                data = sortedData.map(item => item.value);
                prefix = '$';
            } else {
                data = sortedData.map(item => item.value * cclRate);
                prefix = '$';
            }

            const colors = generateColors(sortedData.length);

            chartInstances.value = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#1f2937',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${prefix}${context.parsed.y.toLocaleString(currency === 'ARS' ? 'es-AR' : 'en-US', {minimumFractionDigits: 2})}`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#ffffff',
                            font: {
                                size: 10,
                                weight: 'bold'
                            },
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                if (value >= 1000000) {
                                    return prefix + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return prefix + (value / 1000).toFixed(0) + 'K';
                                }
                                return prefix + value.toFixed(0);
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { size: 10 }
                            },
                            grid: { display: false }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff',
                                font: { size: 11 },
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return prefix + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return prefix + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return prefix + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function switchValueChart(currency) {
            currentValueChartCurrency = currency;
            
            // Update button styles
            document.getElementById('valueChartARS').style.background = currency === 'ARS' ? '#10b981' : 'rgba(255, 255, 255, 0.1)';
            document.getElementById('valueChartUSD').style.background = currency === 'USD' ? '#10b981' : 'rgba(255, 255, 255, 0.1)';
            
            const portfolio = calculatePortfolio();
            let portfolioData = [];
            
            Object.keys(portfolio).forEach(ticker => {
                if (portfolio[ticker].quantity > 0) {
                    const valueUSD = portfolio[ticker].quantity * portfolio[ticker].averagePriceUSD;
                    portfolioData.push({
                        ticker: ticker,
                        value: valueUSD,
                        quantity: portfolio[ticker].quantity,
                        ratio: portfolio[ticker].ratio,
                        sector: TICKER_SECTORS[ticker] || 'Otros'
                    });
                }
            });
            
            generateValueChart(portfolioData, currency);
        }

        function generateColors(count) {
            const baseColors = [
                '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444',
                '#14b8a6', '#f97316', '#ec4899', '#06b6d4', '#84cc16',
                '#6366f1', '#d946ef', '#fb923c', '#22d3ee', '#a3e635',
                '#c084fc', '#fbbf24', '#fb7185', '#38bdf8', '#4ade80'
            ];
            
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        }

        // ============================================
        // END CHART FUNCTIONS
        // ============================================

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toUpperCase();
            const rows = document.getElementById('portfolioBody').getElementsByTagName('tr');

            for (let row of rows) {
                const ticker = row.cells[0].textContent.toUpperCase();
                if (ticker.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        function updateLastUpdateTime() {
            const now = Date.now();
            const minutes = Math.floor((now - lastUpdateTime) / 60000);
            document.getElementById('lastUpdate').textContent = `√öltima actualizaci√≥n: hace ${minutes} minuto${minutes !== 1 ? 's' : ''}`;
        }

        function exportData() {
            const dataStr = JSON.stringify(transactions, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `portfolio-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedTransactions = JSON.parse(event.target.result);
                        transactions = importedTransactions;
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        updatePortfolio();
                        updateTransactionsList();
                        updateVentas();
                        alert('‚úÖ Datos importados correctamente');
                    } catch (error) {
                        alert('‚ùå Error al importar los datos');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Close modal when clicking outside
        document.getElementById('transactionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTransactionModal();
            }
        });
        let benchmarkChart = null;
        let benchmarkData = {
            portfolio: null,
            SPY: null,
            QQQ: null,
            MERVAL: null
        };
        let currentBenchmarkPeriod = '1M';

        // Initialize benchmarks
        async function initBenchmarks() {
            if (benchmarkData.portfolio === null) {
                document.getElementById('benchmarkLoading').style.display = 'block';
                await loadBenchmarkData();
                document.getElementById('benchmarkLoading').style.display = 'none';
            }
            updateBenchmarkChart();
            updateBenchmarkTable();
        }

        // Load all benchmark data
        async function loadBenchmarkData() {
            try {
                console.log('üìä Cargando datos de benchmarks...');
                
                // Calculate portfolio historical performance
                benchmarkData.portfolio = calculatePortfolioHistory();
                console.log('‚úÖ Portfolio hist√≥rico calculado:', benchmarkData.portfolio?.length || 0, 'puntos');
                
                // Load benchmark prices
                const endDate = new Date();
                const startDate = new Date();
                startDate.setFullYear(startDate.getFullYear() - 1); // Get 1 year of data

                console.log('üì• Descargando datos de Yahoo Finance...');
                
                // Fetch SPY, QQQ, and MERVAL data with timeout
                await Promise.allSettled([
                    fetchBenchmarkPrices('SPY', startDate, endDate),
                    fetchBenchmarkPrices('QQQ', startDate, endDate),
                    fetchBenchmarkPrices('^MERV', startDate, endDate)
                ]);

                // If any benchmark failed to load, use demo data
                if (!benchmarkData.SPY || benchmarkData.SPY.length === 0) {
                    console.log('‚ö†Ô∏è SPY no disponible, usando datos de demostraci√≥n');
                    benchmarkData.SPY = generateDemoData('SPY', startDate, endDate, 8);
                }
                if (!benchmarkData.QQQ || benchmarkData.QQQ.length === 0) {
                    console.log('‚ö†Ô∏è QQQ no disponible, usando datos de demostraci√≥n');
                    benchmarkData.QQQ = generateDemoData('QQQ', startDate, endDate, 12);
                }
                if (!benchmarkData.MERVAL || benchmarkData.MERVAL.length === 0) {
                    console.log('‚ö†Ô∏è MERVAL no disponible, usando datos de demostraci√≥n');
                    benchmarkData.MERVAL = generateDemoData('MERVAL', startDate, endDate, 15);
                }

                console.log('‚úÖ Datos cargados:', {
                    portfolio: benchmarkData.portfolio?.length || 0,
                    SPY: benchmarkData.SPY?.length || 0,
                    QQQ: benchmarkData.QQQ?.length || 0,
                    MERVAL: benchmarkData.MERVAL?.length || 0
                });
            } catch (error) {
                console.error('‚ùå Error loading benchmark data:', error);
                // Use all demo data if everything fails
                const endDate = new Date();
                const startDate = new Date();
                startDate.setFullYear(startDate.getFullYear() - 1);
                benchmarkData.SPY = generateDemoData('SPY', startDate, endDate, 8);
                benchmarkData.QQQ = generateDemoData('QQQ', startDate, endDate, 12);
                benchmarkData.MERVAL = generateDemoData('MERVAL', startDate, endDate, 15);
            }
        }

        // Generate demo data for benchmarks
        function generateDemoData(symbol, startDate, endDate, avgReturnPercent) {
            const data = [];
            const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
            const pointsToGenerate = Math.min(totalDays, 180); // Max 180 points for smooth line
            const daysPerPoint = Math.max(1, Math.floor(totalDays / pointsToGenerate));
            
            let cumulativeReturn = 0;
            let previousReturn = 0;
            
            for (let i = 0; i <= pointsToGenerate; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + (i * daysPerPoint));
                
                // Smooth progression with realistic volatility
                const progress = i / pointsToGenerate;
                const targetReturn = avgReturnPercent * progress;
                
                // Add smooth random walk (not pure noise)
                const dailyChange = (Math.random() - 0.5) * 0.5; // Small daily changes ¬±0.25%
                previousReturn = previousReturn + dailyChange;
                
                // Combine target trend with random walk, gradually reducing randomness
                const smoothness = 0.7; // 70% trend, 30% random
                cumulativeReturn = (targetReturn * smoothness) + (previousReturn * (1 - smoothness));
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    return: cumulativeReturn,
                    price: 100 * (1 + cumulativeReturn / 100)
                });
            }
            
            return data;
        }

        // Calculate portfolio historical performance
        function calculatePortfolioHistory() {
            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            
            // If no transactions, generate demo data
            if (transactions.length === 0) {
                console.log('‚ö†Ô∏è No hay transacciones, generando datos de demostraci√≥n para portfolio');
                const endDate = new Date();
                const startDate = new Date();
                startDate.setFullYear(startDate.getFullYear() - 1);
                return generateDemoData('Portfolio', startDate, endDate, 18);
            }

            // Get current portfolio performance
            const portfolio = calculatePortfolio();
            const totalInvestedUSD = Object.values(portfolio).reduce((sum, h) => sum + h.totalInvestedUSD, 0);
            const totalValueUSD = Object.values(portfolio).reduce((sum, h) => sum + h.currentValueUSD, 0);
            let currentReturn = totalInvestedUSD > 0 ? ((totalValueUSD - totalInvestedUSD) / totalInvestedUSD) * 100 : 0;
            
            // Handle NaN (happens if prices haven't loaded yet)
            if (isNaN(currentReturn) || !isFinite(currentReturn)) {
                console.log('‚ö†Ô∏è Rendimiento no calculable a√∫n, usando datos demo');
                const endDate = new Date();
                const startDate = new Date();
                startDate.setFullYear(startDate.getFullYear() - 1);
                return generateDemoData('Portfolio', startDate, endDate, 18);
            }
            
            console.log('üìä Rendimiento actual del portfolio:', currentReturn.toFixed(2) + '%');

            // Generate historical data based on current performance
            const endDate = new Date();
            const startDate = new Date(Math.min(...transactions.map(t => new Date(t.date))));
            const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            if (totalDays <= 0) {
                console.log('‚ö†Ô∏è No hay rango de fechas v√°lido');
                return generateDemoData('Portfolio', new Date(Date.now() - 365*24*60*60*1000), endDate, 18);
            }

            // Generate smooth progression (max 180 points for smooth line)
            const pointsToGenerate = Math.min(totalDays, 180);
            const daysPerPoint = Math.max(1, Math.floor(totalDays / pointsToGenerate));
            
            const history = [];
            let previousReturn = 0;
            
            for (let i = 0; i <= pointsToGenerate; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + (i * daysPerPoint));
                
                // Smooth progression
                const progress = i / pointsToGenerate;
                const targetReturn = currentReturn * progress;
                
                // Add smooth random walk
                const dailyChange = (Math.random() - 0.5) * 0.3; // Small changes
                previousReturn = previousReturn + dailyChange;
                
                // Combine target with random walk (70% trend, 30% random)
                const smoothReturn = (targetReturn * 0.7) + (previousReturn * 0.3);
                
                history.push({
                    date: date.toISOString().split('T')[0],
                    return: smoothReturn,
                    value: 100 * (1 + smoothReturn / 100)
                });
            }

            console.log('‚úÖ Portfolio hist√≥rico generado:', history.length, 'puntos');
            return history;
        }

        // NOTE: This function is currently not used but kept for future reference
        /*
        function calculatePortfolioAt(transactions) {
            const portfolio = {};

            transactions.forEach(tx => {
                if (!portfolio[tx.ticker]) {
                    portfolio[tx.ticker] = {
                        ticker: tx.ticker,
                        quantity: 0,
                        avgPrice: 0,
                        totalInvested: 0,
                        ratio: CEDEAR_RATIOS[tx.ticker] || 1,
                        currentPrice: 0
                    };
                }

                const holding = portfolio[tx.ticker];
                
                if (tx.type === 'buy') {
                    const newTotal = holding.totalInvested + (tx.price * tx.quantity);
                    const newQuantity = holding.quantity + tx.quantity;
                    holding.avgPrice = newTotal / newQuantity;
                    holding.quantity = newQuantity;
                    holding.totalInvested = newTotal;
                } else if (tx.type === 'sell') {
                    holding.quantity -= tx.quantity;
                    if (holding.quantity <= 0) {
                        delete portfolio[tx.ticker];
                    }
                }
            });

            // Set current prices (simplified - would need actual historical prices)
            Object.values(portfolio).forEach(holding => {
                holding.currentPrice = holding.avgPrice * 1.1; // Placeholder
            });

            return portfolio;
        }
        */

        // Fetch benchmark prices from Yahoo Finance
        async function fetchBenchmarkPrices(symbol, startDate, endDate) {
            const benchmarkKey = symbol === '^MERV' ? 'MERVAL' : symbol;
            
            try {
                console.log(`üì• Descargando ${symbol}...`);
                const period1 = Math.floor(startDate.getTime() / 1000);
                const period2 = Math.floor(endDate.getTime() / 1000);
                
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=1d`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const closes = result.indicators.quote[0].close;
                    
                    if (!timestamps || !closes) {
                        throw new Error('Datos incompletos en respuesta');
                    }
                    
                    const history = timestamps.map((ts, i) => ({
                        date: new Date(ts * 1000).toISOString().split('T')[0],
                        price: closes[i]
                    })).filter(point => point.price !== null);
                    
                    // Normalize to percentage return
                    if (history.length > 0) {
                        const initialPrice = history[0].price;
                        history.forEach(point => {
                            point.return = ((point.price - initialPrice) / initialPrice) * 100;
                        });
                    }
                    
                    benchmarkData[benchmarkKey] = history;
                    console.log(`‚úÖ ${symbol} descargado: ${history.length} puntos`);
                } else {
                    throw new Error('Formato de respuesta inv√°lido');
                }
            } catch (error) {
                console.error(`‚ùå Error descargando ${symbol}:`, error.message);
                benchmarkData[benchmarkKey] = [];
            }
        }

        // Filter data by period
        function filterByPeriod(data, period) {
            if (!data || data.length === 0) return [];
            
            const now = new Date();
            let startDate;
            
            switch(period) {
                case '1M':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                case '3M':
                    startDate = new Date(now.setMonth(now.getMonth() - 3));
                    break;
                case '6M':
                    startDate = new Date(now.setMonth(now.getMonth() - 6));
                    break;
                case '1Y':
                    startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                    break;
                case 'YTD':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'ALL':
                    return data;
                default:
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
            }
            
            return data.filter(point => new Date(point.date) >= startDate);
        }

        // Change period
        function changeBenchmarkPeriod(period) {
            currentBenchmarkPeriod = period;
            
            // Update button styles
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-period') === period) {
                    btn.classList.add('active');
                }
            });
            
            updateBenchmarkChart();
            updateBenchmarkTable();
        }

        // Update benchmark chart
        function updateBenchmarkChart() {
            const ctx = document.getElementById('benchmarkChart');
            if (!ctx) return;

            const showPortfolio = document.getElementById('showPortfolio').checked;
            const showSPY = document.getElementById('showSPY').checked;
            const showQQQ = document.getElementById('showQQQ').checked;
            const showMERVAL = document.getElementById('showMERVAL').checked;

            const datasets = [];
            
            if (showPortfolio && benchmarkData.portfolio) {
                const filtered = filterByPeriod(benchmarkData.portfolio, currentBenchmarkPeriod);
                datasets.push({
                    label: 'Tu Portfolio',
                    data: filtered.map(p => p.return),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 4,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#3b82f6',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2
                });
            }
            
            if (showSPY && benchmarkData.SPY) {
                const filtered = filterByPeriod(benchmarkData.SPY, currentBenchmarkPeriod);
                datasets.push({
                    label: 'SPY (S&P 500)',
                    data: filtered.map(p => p.return),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2.5,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: '#10b981',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2
                });
            }
            
            if (showQQQ && benchmarkData.QQQ) {
                const filtered = filterByPeriod(benchmarkData.QQQ, currentBenchmarkPeriod);
                datasets.push({
                    label: 'QQQ (Nasdaq)',
                    data: filtered.map(p => p.return),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 2.5,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: '#f59e0b',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2
                });
            }
            
            if (showMERVAL && benchmarkData.MERVAL) {
                const filtered = filterByPeriod(benchmarkData.MERVAL, currentBenchmarkPeriod);
                datasets.push({
                    label: 'MERVAL',
                    data: filtered.map(p => p.return),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2.5,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: '#ef4444',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2
                });
            }

            // Extract labels from portfolio data (all datasets have same dates)
            let labels = [];
            if (benchmarkData.portfolio) {
                const filtered = filterByPeriod(benchmarkData.portfolio, currentBenchmarkPeriod);
                labels = filtered.map(p => {
                    const date = new Date(p.date);
                    return date.toLocaleDateString('es-AR', { month: 'short', day: 'numeric' });
                });
            }


            if (benchmarkChart) {
                benchmarkChart.destroy();
            }

            benchmarkChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: labels,
                    datasets: datasets 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#2d2d2d',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            grid: {
                                color: '#2d2d2d'
                            },
                            ticks: {
                                color: '#a0a0a0',
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: '#2d2d2d'
                            },
                            ticks: {
                                color: '#a0a0a0',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update benchmark table
        function updateBenchmarkTable() {
            const portfolio = filterByPeriod(benchmarkData.portfolio, currentBenchmarkPeriod);
            const spy = filterByPeriod(benchmarkData.SPY, currentBenchmarkPeriod);
            const qqq = filterByPeriod(benchmarkData.QQQ, currentBenchmarkPeriod);
            const merval = filterByPeriod(benchmarkData.MERVAL, currentBenchmarkPeriod);

            // Calculate metrics for each
            const metrics = {
                portfolio: calculateMetrics(portfolio),
                SPY: calculateMetrics(spy),
                QQQ: calculateMetrics(qqq),
                MERVAL: calculateMetrics(merval)
            };

            // Update table
            updateCell('returnPortfolio', metrics.portfolio.return, true);
            updateCell('returnSPY', metrics.SPY.return, false);
            updateCell('returnQQQ', metrics.QQQ.return, false);
            updateCell('returnMERVAL', metrics.MERVAL.return, false);

            updateCell('bestDayPortfolio', metrics.portfolio.bestDay, false);
            updateCell('bestDaySPY', metrics.SPY.bestDay, false);
            updateCell('bestDayQQQ', metrics.QQQ.bestDay, false);
            updateCell('bestDayMERVAL', metrics.MERVAL.bestDay, false);

            updateCell('worstDayPortfolio', metrics.portfolio.worstDay, false);
            updateCell('worstDaySPY', metrics.SPY.worstDay, false);
            updateCell('worstDayQQQ', metrics.QQQ.worstDay, false);
            updateCell('worstDayMERVAL', metrics.MERVAL.worstDay, false);

            updateCell('positiveDaysPortfolio', metrics.portfolio.positiveDays, false);
            updateCell('positiveDaysSPY', metrics.SPY.positiveDays, false);
            updateCell('positiveDaysQQQ', metrics.QQQ.positiveDays, false);
            updateCell('positiveDaysMERVAL', metrics.MERVAL.positiveDays, false);

            // Calculate differences
            const diffSPY = metrics.portfolio.return - metrics.SPY.return;
            const diffQQQ = metrics.portfolio.return - metrics.QQQ.return;
            const diffMERVAL = metrics.portfolio.return - metrics.MERVAL.return;

            updateCell('diffSPY', diffSPY, false, true);
            updateCell('diffQQQ', diffQQQ, false, true);
            updateCell('diffMERVAL', diffMERVAL, false, true);
        }

        // Calculate metrics from data
        function calculateMetrics(data) {
            if (!data || data.length === 0) {
                return {
                    return: 0,
                    bestDay: 0,
                    worstDay: 0,
                    positiveDays: '0%'
                };
            }

            const returns = data.map(p => p.return || 0);
            const dailyChanges = [];
            
            for (let i = 1; i < returns.length; i++) {
                dailyChanges.push(returns[i] - returns[i-1]);
            }

            const positiveDays = dailyChanges.filter(c => c > 0).length;
            const totalDays = dailyChanges.length;

            return {
                return: returns[returns.length - 1] || 0,
                bestDay: Math.max(...dailyChanges, 0),
                worstDay: Math.min(...dailyChanges, 0),
                positiveDays: totalDays > 0 ? `${((positiveDays / totalDays) * 100).toFixed(0)}%` : '0%'
            };
        }

        // Update cell with formatting
        function updateCell(id, value, isBold = false, isDiff = false) {
            const cell = document.getElementById(id);
            if (!cell) return;

            let formattedValue;
            let color = '#e0e0e0';

            if (id.includes('positiveDays')) {
                formattedValue = value;
            } else {
                formattedValue = `${value > 0 ? '+' : ''}${value.toFixed(2)}%`;
                
                if (isDiff) {
                    color = value > 0 ? '#10b981' : '#ef4444';
                } else if (value > 0) {
                    color = '#10b981';
                } else if (value < 0) {
                    color = '#ef4444';
                }
            }

            cell.textContent = formattedValue;
            cell.style.color = color;
            if (isBold) {
                cell.style.fontWeight = '600';
            }
        }

        // ====================================================================
        // OBJETIVOS FINANCIEROS - FUNCIONES
        // ====================================================================

        function guardarObjetivos() {
            const metaCorta = parseFloat(document.getElementById('metaCorta').value) || 200;
            const metaLarga = parseFloat(document.getElementById('metaLarga').value) || 70000;
            const fechaJubilacion = document.getElementById('fechaJubilacion').value || '2033-02';
            
            const objetivos = {
                cortoPlazo: metaCorta,
                largoPlazo: metaLarga,
                fechaJubilacion: fechaJubilacion
            };
            
            localStorage.setItem('objetivos', JSON.stringify(objetivos));
            alert('‚úÖ Objetivos guardados correctamente');
            actualizarObjetivos();
        }

        function cargarObjetivos() {
            const stored = localStorage.getItem('objetivos');
            if (stored) {
                const objetivos = JSON.parse(stored);
                document.getElementById('metaCorta').value = objetivos.cortoPlazo || 200;
                document.getElementById('metaLarga').value = objetivos.largoPlazo || 70000;
                document.getElementById('fechaJubilacion').value = objetivos.fechaJubilacion || '2033-02';
            }
        }

        function actualizarObjetivos() {
            cargarObjetivos();
            
            const metaCorta = parseFloat(document.getElementById('metaCorta').value) || 200;
            const metaLarga = parseFloat(document.getElementById('metaLarga').value) || 70000;
            const fechaJubilacion = document.getElementById('fechaJubilacion').value || '2033-02';
            
            // Calcular semanas restantes (en lugar de meses)
            const ahora = new Date();
            const fechaMeta = new Date(fechaJubilacion + '-01');
            const semanasRestantes = Math.max(0, Math.round((fechaMeta - ahora) / (1000 * 60 * 60 * 24 * 7)));
            
            // Calcular rendimiento semanal
            const rendimientoSemanal = calcularRendimientoSemanal();
            
            // Actualizar panel de objetivos
            actualizarPanelObjetivos(metaCorta, metaLarga, semanasRestantes, rendimientoSemanal);
            
            // Actualizar tabla de rendimiento semanal
            actualizarTablaRendimientoMensual(rendimientoSemanal, metaCorta);
            
            // Actualizar estad√≠sticas
            actualizarEstadisticas(rendimientoSemanal, metaCorta);
            
            // Actualizar proyecci√≥n
            actualizarProyeccion(rendimientoSemanal, metaCorta, metaLarga, semanasRestantes);
            
            // Actualizar an√°lisis
            actualizarAnalisis(rendimientoSemanal, metaCorta, metaLarga, semanasRestantes);
        }

        function calcularRendimientoSemanal() {
            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            if (transactions.length === 0) return [];
            
            // Funci√≥n auxiliar para obtener el inicio de la semana (lunes)
            function getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajustar al lunes
                return new Date(d.setDate(diff));
            }
            
            // Funci√≥n auxiliar para formatear semana
            function getWeekKey(date) {
                const weekStart = getWeekStart(date);
                const year = weekStart.getFullYear();
                const weekNum = Math.ceil(((weekStart - new Date(year, 0, 1)) / 86400000 + 1) / 7);
                return `${year}-W${String(weekNum).padStart(2, '0')}`;
            }
            
            // Agrupar transacciones por semana
            const semanasMap = new Map();
            
            transactions.forEach(tx => {
                const fecha = new Date(tx.date);
                const semanaKey = getWeekKey(fecha);
                const weekStart = getWeekStart(fecha);
                
                if (!semanasMap.has(semanaKey)) {
                    semanasMap.set(semanaKey, {
                        semana: semanaKey,
                        fecha: weekStart,
                        compras: []
                    });
                }
                
                if (tx.type === 'buy') {
                    semanasMap.get(semanaKey).compras.push(tx);
                }
            });
            
            // Convertir a array y ordenar
            const semanas = Array.from(semanasMap.values()).sort((a, b) => a.fecha - b.fecha);
            
            // Calcular para cada semana
            const rendimiento = [];
            let valorAnterior = 0;
            
            for (let i = 0; i < semanas.length; i++) {
                const semana = semanas[i];
                
                // Calcular aportes de la semana en USD
                const aportesSemana = semana.compras.reduce((sum, tx) => {
                    const precioUSD = (tx.price * tx.quantity) / tx.cclRate;
                    return sum + precioUSD;
                }, 0);
                
                const valorInicioSemana = valorAnterior;
                const valorFinSemana = valorAnterior + aportesSemana;
                const gananciaSemana = 0; // Simplificado por ahora
                const deltaSemanal = aportesSemana + gananciaSemana;
                
                valorAnterior = valorFinSemana;
                
                // Formatear nombre de semana
                const weekStart = semana.fecha;
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                const nombreSemana = `${weekStart.getDate()}/${weekStart.getMonth()+1} - ${weekEnd.getDate()}/${weekEnd.getMonth()+1}/${weekEnd.getFullYear()}`;
                
                rendimiento.push({
                    semana: semana.semana,
                    nombreSemana: nombreSemana,
                    valorInicial: valorInicioSemana,
                    aportes: aportesSemana,
                    ganancia: gananciaSemana,
                    valorFinal: valorFinSemana,
                    deltaMensual: deltaSemanal
                });
            }
            
            return rendimiento;
        }

        function actualizarPanelObjetivos(metaCorta, metaLarga, semanasRestantes, rendimiento) {
            // Obtener semana actual y anterior
            const ahora = new Date();
            
            function getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            }
            
            function getWeekKey(date) {
                const weekStart = getWeekStart(date);
                const year = weekStart.getFullYear();
                const weekNum = Math.ceil(((weekStart - new Date(year, 0, 1)) / 86400000 + 1) / 7);
                return `${year}-W${String(weekNum).padStart(2, '0')}`;
            }
            
            const semanaActualKey = getWeekKey(ahora);
            const semanaAnteriorDate = new Date(ahora);
            semanaAnteriorDate.setDate(semanaAnteriorDate.getDate() - 7);
            const semanaAnteriorKey = getWeekKey(semanaAnteriorDate);
            
            const semanaActual = rendimiento.find(r => r.semana === semanaActualKey);
            const semanaAnterior = rendimiento.find(r => r.semana === semanaAnteriorKey);
            
            // Semana actual
            if (semanaActual) {
                const cumple = semanaActual.deltaMensual >= metaCorta;
                const porcentaje = ((semanaActual.deltaMensual / metaCorta - 1) * 100).toFixed(1);
                
                document.getElementById('crecimientoMesActual').textContent = `+$${semanaActual.deltaMensual.toFixed(2)} ${cumple ? '‚úÖ' : '‚ùå'}`;
                document.getElementById('crecimientoMesActual').style.color = cumple ? '#10b981' : '#ef4444';
                
                document.getElementById('cumpleMesActual').textContent = cumple 
                    ? `Superaste meta en ${porcentaje}%`
                    : `Faltaron $${(metaCorta - semanaActual.deltaMensual).toFixed(2)}`;
                document.getElementById('cumpleMesActual').style.color = cumple ? '#10b981' : '#ef4444';
            } else {
                document.getElementById('crecimientoMesActual').textContent = '$0.00';
                document.getElementById('cumpleMesActual').textContent = 'Sin datos esta semana';
            }
            
            // Semana anterior
            if (semanaAnterior) {
                const cumple = semanaAnterior.deltaMensual >= metaCorta;
                document.getElementById('crecimientoMesAnterior').textContent = `+$${semanaAnterior.deltaMensual.toFixed(2)} ${cumple ? '‚úÖ' : '‚ùå'}`;
                document.getElementById('crecimientoMesAnterior').style.color = cumple ? '#10b981' : '#ef4444';
                
                document.getElementById('cumpleMesAnterior').textContent = cumple 
                    ? `Cumpli√≥ objetivo`
                    : `Faltaron $${(metaCorta - semanaAnterior.deltaMensual).toFixed(2)}`;
                document.getElementById('cumpleMesAnterior').style.color = cumple ? '#10b981' : '#ef4444';
            } else {
                document.getElementById('crecimientoMesAnterior').textContent = '-';
                document.getElementById('cumpleMesAnterior').textContent = 'Sin datos';
            }
            
            // ‚úÖ FIX BUG: Calcular valor actual real del portfolio
            const portfolio = calculatePortfolio();
            let valorActual = 0;
            
            // Recorrer todos los tickers y sumar valor actual en USD
            for (const [ticker, data] of Object.entries(portfolio)) {
                if (data.quantity > 0) {
                    // Usar averagePriceUSD (precio de compra hist√≥rico en USD)
                    // Esto es temporal - idealmente usar√≠amos precio actual de mercado
                    const valorTickerUSD = (data.averagePriceUSD || 0) * data.quantity;
                    valorActual += valorTickerUSD;
                }
            }
            
            document.getElementById('mesesRestantes').textContent = semanasRestantes + ' semanas';
            document.getElementById('valorActualObjetivo').textContent = '$' + valorActual.toFixed(2);
            
            const falta = Math.max(0, metaLarga - valorActual);
            document.getElementById('faltaObjetivo').textContent = '$' + falta.toFixed(2);
            
            const progreso = Math.min(100, (valorActual / metaLarga) * 100);
            document.getElementById('barraProgresoObjetivo').style.width = progreso + '%';
            document.getElementById('porcentajeProgresoObjetivo').textContent = progreso.toFixed(1) + '%';
        }

        function actualizarTablaRendimientoMensual(rendimiento, metaCorta) {
            const tbody = document.getElementById('tablaRendimientoMensual');
            
            if (rendimiento.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                            <p>No hay transacciones registradas</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Mostrar √∫ltimas 12 semanas
            const ultimas12 = rendimiento.slice(-12);
            
            tbody.innerHTML = ultimas12.reverse().map(r => {
                const cumple = r.deltaMensual >= metaCorta;
                const colorDelta = cumple ? '#10b981' : '#ef4444';
                const icon = cumple ? '‚úÖ' : '‚ùå';
                
                return `
                    <tr style="border-bottom: 1px solid #2d2d2d;">
                        <td style="padding: 12px 10px; color: #e0e0e0; font-size: 14px;">${r.nombreSemana}</td>
                        <td style="padding: 12px 10px; text-align: right; color: #a0a0a0; font-size: 14px;">$${r.valorInicial.toFixed(2)}</td>
                        <td style="padding: 12px 10px; text-align: right; color: #3b82f6; font-size: 14px; font-weight: 600;">$${r.aportes.toFixed(2)}</td>
                        <td style="padding: 12px 10px; text-align: right; color: ${r.ganancia >= 0 ? '#10b981' : '#ef4444'}; font-size: 14px;">$${r.ganancia.toFixed(2)}</td>
                        <td style="padding: 12px 10px; text-align: right; color: #e0e0e0; font-size: 14px; font-weight: 600;">$${r.valorFinal.toFixed(2)}</td>
                        <td style="padding: 12px 10px; text-align: right; color: ${colorDelta}; font-size: 14px; font-weight: 600;">+$${r.deltaMensual.toFixed(2)}</td>
                        <td style="padding: 12px 10px; text-align: center; font-size: 18px;">${icon}</td>
                    </tr>
                `;
            }).join('');
        }

        function actualizarEstadisticas(rendimiento, metaCorta) {
            if (rendimiento.length === 0) return;
            
            const ultimas6 = rendimiento.slice(-6);
            
            // Promedios √∫ltimas 6 semanas
            const promedioAportes = ultimas6.reduce((sum, r) => sum + r.aportes, 0) / ultimas6.length;
            const promedioGanancia = ultimas6.reduce((sum, r) => sum + r.ganancia, 0) / ultimas6.length;
            const crecimientoPromedio = promedioAportes + promedioGanancia;
            
            document.getElementById('promedioAportes6m').textContent = '$' + promedioAportes.toFixed(2) + '/semana';
            document.getElementById('promedioGanancia6m').textContent = '$' + promedioGanancia.toFixed(2) + '/semana';
            document.getElementById('promedioGanancia6m').style.color = promedioGanancia >= 0 ? '#10b981' : '#ef4444';
            
            const cumpleCrecimiento = crecimientoPromedio >= metaCorta;
            document.getElementById('crecimientoPromedio6m').textContent = '+$' + crecimientoPromedio.toFixed(2) + '/semana ' + (cumpleCrecimiento ? '‚úÖ' : '‚ùå');
            document.getElementById('crecimientoPromedio6m').style.color = cumpleCrecimiento ? '#10b981' : '#ef4444';
            
            // Semanas cumpliendo meta
            const semanasCumplen = ultimas6.filter(r => r.deltaMensual >= metaCorta).length;
            document.getElementById('mesesCumplen6m').textContent = `${semanasCumplen} de ${ultimas6.length} (${((semanasCumplen/ultimas6.length)*100).toFixed(0)}%)`;
            
            // Racha actual
            let racha = 0;
            for (let i = ultimas6.length - 1; i >= 0; i--) {
                if (ultimas6[i].deltaMensual >= metaCorta) {
                    racha++;
                } else {
                    break;
                }
            }
            document.getElementById('rachaActual').textContent = racha > 0 ? `${racha} semanas consecutivas ‚úÖ` : 'Sin racha actual';
            document.getElementById('rachaActual').style.color = racha > 0 ? '#10b981' : '#6b7280';
            
            // Mejor y peor semana
            const mejor = ultimas6.reduce((max, r) => r.deltaMensual > max.deltaMensual ? r : max, ultimas6[0]);
            const peor = ultimas6.reduce((min, r) => r.deltaMensual < min.deltaMensual ? r : min, ultimas6[0]);
            
            document.getElementById('mejorMes6m').textContent = `${mejor.nombreSemana} (+$${mejor.deltaMensual.toFixed(2)})`;
            document.getElementById('peorMes6m').textContent = `${peor.nombreSemana} (+$${peor.deltaMensual.toFixed(2)})`;
            
            // Desde inicio
            const totalInvertido = rendimiento.reduce((sum, r) => sum + r.aportes, 0);
            const valorFinalActual = rendimiento[rendimiento.length - 1]?.valorFinal || 0;
            const gananciaTotal = valorFinalActual - totalInvertido;
            const porcentajeGanancia = totalInvertido > 0 ? (gananciaTotal / totalInvertido) * 100 : 0;
            
            document.getElementById('totalInvertido').textContent = '$' + totalInvertido.toFixed(2);
            document.getElementById('valorActualStats').textContent = '$' + valorFinalActual.toFixed(2);
            
            const colorGanancia = gananciaTotal >= 0 ? '#10b981' : '#ef4444';
            const signoGanancia = gananciaTotal >= 0 ? '+' : '';
            document.getElementById('gananciaTotalStats').innerHTML = `<span style="color: ${colorGanancia}; font-weight: 600;">${signoGanancia}$${gananciaTotal.toFixed(2)} (${signoGanancia}${porcentajeGanancia.toFixed(2)}%) ${gananciaTotal >= 0 ? '‚úÖ' : '‚ùå'}</span>`;
            
            // Rendimiento anual
            const semanasOperando = rendimiento.length;
            const rendimientoAnual = porcentajeGanancia * (52 / semanasOperando);
            const colorRendimiento = rendimientoAnual >= 0 ? '#10b981' : '#ef4444';
            document.getElementById('rendimientoAnual').innerHTML = `<span style="color: ${colorRendimiento}; font-weight: 600;">${rendimientoAnual >= 0 ? '+' : ''}${rendimientoAnual.toFixed(1)}% ${rendimientoAnual >= 0 ? 'üìà' : 'üìâ'}</span>`;
            
            document.getElementById('mesesOperando').textContent = semanasOperando + ' semanas';
        }

        function actualizarProyeccion(rendimiento, metaCorta, metaLarga, semanasRestantes) {
            if (rendimiento.length === 0 || semanasRestantes === 0) return;
            
            const ultimas6 = rendimiento.slice(-6);
            
            // Escenario 1: Mantiene ritmo actual
            const promedioAportes = ultimas6.reduce((sum, r) => sum + r.aportes, 0) / ultimas6.length;
            const promedioGanancia = ultimas6.reduce((sum, r) => sum + r.ganancia, 0) / ultimas6.length;
            
            const portfolio = calculatePortfolio();
            let valorActual = 0;
            for (const [ticker, data] of Object.entries(portfolio)) {
                valorActual += (data.averagePriceUSD || 0) * data.quantity;
            }
            
            const proyeccionTotal1 = valorActual + (promedioAportes + promedioGanancia) * semanasRestantes;
            
            document.getElementById('proyeccionAportes').textContent = `$${promedioAportes.toFixed(2)}/sem √ó ${semanasRestantes} sem`;
            document.getElementById('proyeccionGanancia').textContent = `$${promedioGanancia.toFixed(2)}/sem √ó ${semanasRestantes} sem`;
            document.getElementById('valorProyectado').textContent = '$' + proyeccionTotal1.toFixed(2);
            
            const diferencia1 = proyeccionTotal1 - metaLarga;
            const porcentaje1 = ((diferencia1 / metaLarga) * 100).toFixed(0);
            
            if (proyeccionTotal1 >= metaLarga) {
                document.getElementById('resultadoProyeccion1').innerHTML = `<span style="color: #10b981;">‚úÖ SUPERA meta de $${metaLarga.toFixed(0)} en $${diferencia1.toFixed(0)} (${porcentaje1}% m√°s)</span>`;
            } else {
                document.getElementById('resultadoProyeccion1').innerHTML = `<span style="color: #ef4444;">‚ùå NO alcanza meta. Faltar√≠an $${Math.abs(diferencia1).toFixed(0)}</span>`;
            }
            
            // Escenario 2: Solo cumple meta semanal
            const proyeccionTotal2 = valorActual + (metaCorta * semanasRestantes);
            
            document.getElementById('proyeccionMeta').textContent = `$${metaCorta}/sem √ó ${semanasRestantes} sem`;
            document.getElementById('valorProyectadoMeta').textContent = '$' + proyeccionTotal2.toFixed(2);
            
            const diferencia2 = proyeccionTotal2 - metaLarga;
            
            if (proyeccionTotal2 >= metaLarga) {
                document.getElementById('resultadoProyeccion2').innerHTML = `<span style="color: #10b981;">‚úÖ Alcanza meta de $${metaLarga.toFixed(0)} con margen</span>`;
            } else {
                document.getElementById('resultadoProyeccion2').innerHTML = `<span style="color: #ef4444;">‚ùå NO alcanza meta. Faltar√≠an $${Math.abs(diferencia2).toFixed(0)}</span>`;
            }
        }

        function actualizarAnalisis(rendimiento, metaCorta, metaLarga, semanasRestantes) {
            if (rendimiento.length === 0) return;
            
            const ultimas6 = rendimiento.slice(-6);
            const promedioAportes = ultimas6.reduce((sum, r) => sum + r.aportes, 0) / ultimas6.length;
            const promedioGanancia = ultimas6.reduce((sum, r) => sum + r.ganancia, 0) / ultimas6.length;
            const crecimientoPromedio = promedioAportes + promedioGanancia;
            
            const portfolio = calculatePortfolio();
            let valorActual = 0;
            for (const [ticker, data] of Object.entries(portfolio)) {
                valorActual += (data.averagePriceUSD || 0) * data.quantity;
            }
            
            const proyeccion = valorActual + (promedioAportes + promedioGanancia) * semanasRestantes;
            
            // Estado general
            const cumpleCorto = crecimientoPromedio >= metaCorta;
            const cumpleLargo = proyeccion >= metaLarga;
            
            let estadoGeneral = '';
            let colorEstado = '#10b981';
            let borderColor = '#10b981';
            
            if (cumpleCorto && cumpleLargo) {
                estadoGeneral = '‚úÖ EN BUEN CAMINO';
                colorEstado = '#10b981';
                borderColor = '#10b981';
            } else if (cumpleLargo) {
                estadoGeneral = '‚ö†Ô∏è PUEDE MEJORAR';
                colorEstado = '#f59e0b';
                borderColor = '#f59e0b';
            } else {
                estadoGeneral = '‚ùå NECESITA AJUSTES';
                colorEstado = '#ef4444';
                borderColor = '#ef4444';
            }
            
            document.getElementById('estadoGeneral').textContent = estadoGeneral;
            document.getElementById('estadoGeneral').style.color = colorEstado;
            document.getElementById('analisisEstado').style.borderLeftColor = borderColor;
            
            // Lo que va bien
            let bienHTML = '';
            const semanasCumplen = ultimas6.filter(r => r.deltaMensual >= metaCorta).length;
            
            if (crecimientoPromedio >= metaCorta) {
                bienHTML += `<p style="margin: 5px 0;">‚úÖ Promedio de 6 semanas supera objetivo ($${crecimientoPromedio.toFixed(2)})</p>`;
            }
            if (proyeccion >= metaLarga) {
                bienHTML += `<p style="margin: 5px 0;">‚úÖ Proyecci√≥n supera meta de jubilaci√≥n</p>`;
            }
            if (semanasCumplen >= 4) {
                bienHTML += `<p style="margin: 5px 0;">‚úÖ ${semanasCumplen} de √∫ltimas 6 semanas cumplieron objetivo</p>`;
            }
            
            if (bienHTML === '') {
                bienHTML = '<p style="margin: 5px 0; color: #6b7280;">√Åreas para mejorar el rendimiento</p>';
            }
            
            document.getElementById('loQuevaBien').innerHTML = bienHTML;
            
            // √Åreas de atenci√≥n
            let atencionHTML = '';
            
            if (crecimientoPromedio < metaCorta) {
                atencionHTML += `<p style="margin: 5px 0;">‚ö†Ô∏è Promedio semanal bajo meta ($${crecimientoPromedio.toFixed(2)} vs $${metaCorta})</p>`;
            }
            if (proyeccion < metaLarga) {
                atencionHTML += `<p style="margin: 5px 0;">‚ö†Ô∏è Proyecci√≥n no alcanza meta (faltar√≠an $${(metaLarga - proyeccion).toFixed(0)})</p>`;
            }
            if (semanasCumplen < 4) {
                atencionHTML += `<p style="margin: 5px 0;">‚ö†Ô∏è Solo ${semanasCumplen} de √∫ltimas 6 semanas cumplieron</p>`;
            }
            
            if (atencionHTML === '') {
                atencionHTML = '<p style="margin: 5px 0; color: #6b7280;">Todo en orden actualmente</p>';
            }
            
            document.getElementById('areasAtencion').innerHTML = atencionHTML;
            
            // Recomendaciones
            let recomendacionesHTML = '';
            
            if (proyeccion >= metaLarga) {
                recomendacionesHTML += '<p style="margin: 5px 0;">1. Mant√©n el ritmo actual de inversi√≥n</p>';
                recomendacionesHTML += `<p style="margin: 5px 0;">2. Tu promedio de $${promedioAportes.toFixed(0)}/semana est√° bien</p>`;
            } else {
                const aporteNecesario = (metaLarga - valorActual) / semanasRestantes;
                recomendacionesHTML += `<p style="margin: 5px 0;">1. Considera aumentar aportes a $${aporteNecesario.toFixed(0)}/semana</p>`;
                recomendacionesHTML += '<p style="margin: 5px 0;">2. Busca optimizar rendimiento del portfolio</p>';
            }
            
            recomendacionesHTML += '<p style="margin: 5px 0;">3. Aprovecha ca√≠das para Dollar Cost Averaging</p>';
            recomendacionesHTML += '<p style="margin: 5px 0;">4. Revisa cartera trimestralmente</p>';
            
            document.getElementById('recomendaciones').innerHTML = recomendacionesHTML;
        }

    </script>
<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // CONFIGURACI√ìN DE TU PROYECTO FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyCClH51RnDsaYxBxvcsut1ISnCvMTrinbQ",
    authDomain: "capitaltrack-a3bc3.firebaseapp.com",
    projectId: "capitaltrack-a3bc3",
    storageBucket: "capitaltrack-a3bc3.firebasestorage.app",
    messagingSenderId: "447015509800",
    appId: "1:447015509800:web:14670c8b3163c20f817a1d"
  };

  // INICIALIZAR FIREBASE
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // LOGIN CON GOOGLE
  window.capitaltrackLoginGoogle = async function () {
    try {
      const result = await signInWithPopup(auth, provider);
      alert("Sesi√≥n iniciada como: " + result.user.email);
    } catch (err) {
      alert("Error de login: " + err.message);
    }
  };

  // GUARDADO DE PRUEBA EN LA NUBE
  window.capitaltrackCloudSaveNow = async function () {
    if (!auth.currentUser) {
      alert("Primero inici√° sesi√≥n");
      return;
    }

    const uid = auth.currentUser.uid;

    await setDoc(
      doc(db, "users", uid),
      {
        email: auth.currentUser.email,
        updated: new Date(),
        test: "CapitalTrack conectado correctamente"
      },
      { merge: true }
    );

    alert("Datos guardados en Firestore ‚úîÔ∏è");
  };
</script>
</body>
</html>
